# Exousia Build Configuration
# BlueBuild-compatible YAML specification for declarative bootc image builds
# https://blue-build.org/reference/module/

name: exousia
description: DevSecOps-hardened Fedora bootc image with Sway desktop
image-version: 43

# Base image configuration - can be overridden via build args
base-image: quay.io/fedora/fedora-sway-atomic:43
image-type: fedora-bootc  # or fedora-bootc

# Desktop environment selection
# Use either 'window_manager' or 'desktop_environment', not both
desktop:
  window_manager: sway
  # desktop_environment: kde  # Options: kde, mate
  include_common: true  # Include common base packages

# Container metadata
labels:
  org.opencontainers.image.title: "Exousia"
  org.opencontainers.image.description: "Custom Fedora bootc image with Sway desktop and opinionated package selection"
  org.opencontainers.image.source: "https://github.com/borninthedark/exousia"
  org.opencontainers.image.licenses: "MIT"
  maintainer: "uryu"

# Build configuration
build:
  enable_plymouth: true
  enable_zfs: false

  # Sway Configuration
  # See: https://docs.fedoraproject.org/en-US/fedora-sericea/configuration-guide/
  #
  # Exousia uses custom sway configs from overlays/sway/ by default.
  # This provides:
  #   - Custom sway.desktop, environment, and start-sway script
  #   - Layered config.d snippets in /etc/sway/config.d/
  #   - Compatible with sway-config-minimal for headless/container builds
  #
  # Fedora's layered config system:
  #   * /usr/share/sway/config.d/*.conf (packaged configs)
  #   * /etc/sway/config.d/*.conf (system overrides)
  #   * ~/.config/sway/config.d/*.conf (user overrides)
  #
  # Note: sway-config-upstream has been removed from available options
  # due to its limitations. Use sway-config-minimal for minimal builds.

# Modules define the build steps
modules:
  # System users configuration
  - type: files
    files:
      - src: overlays/base/sysusers/bootc.conf
        dst: /usr/lib/sysusers.d/bootc.conf
        mode: "0644"

  # Initialize system users
  - type: script
    scripts:
      - |
        test -f /etc/passwd || touch /etc/passwd
        test -f /etc/group  || touch /etc/group
        systemd-sysusers || true
        systemd-sysusers --root=/ /usr/lib/sysusers.d/bootc.conf

  # Container authentication
  - type: files
    files:
      - src: containers-auth.conf
        dst: /usr/lib/tmpfiles.d/containers-auth.conf
        mode: "0644"

  # Plymouth theme files (toggleable per image type)
  - type: files
    condition: enable_plymouth == true
    files:
      - src: overlays/sway/configs/plymouth/themes/bgrt-better-luks/
        dst: /usr/share/plymouth/themes/bgrt-better-luks/
        mode: "0644"

  # Custom repositories
  - type: files
    files:
      - src: overlays/sway/repos/
        dst: /etc/yum.repos.d/
        mode: "0644"

  # Import GPG keys for third-party repos
  - type: script
    scripts:
      - rpm --import https://dl.google.com/linux/linux_signing_key.pub

  # Base configurations (PAM, polkit, tmpfiles)
  - type: files
    files:
      - src: overlays/base/configs/
        dst: /etc/
        mode: "0644"

  # Sway configurations (greetd, sway, swaylock)
  - type: files
    files:
      - src: overlays/sway/configs/
        dst: /etc/
        mode: "0644"

  # Base scripts
  - type: files
    files:
      - src: overlays/base/tools/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway setup scripts
  - type: files
    files:
      - src: overlays/sway/scripts/setup/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway runtime scripts
  - type: files
    files:
      - src: overlays/sway/scripts/runtime/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway session files (custom Exousia configs)
  - type: files
    files:
      - src: overlays/sway/session/sway.desktop
        dst: /usr/share/wayland-sessions/sway.desktop
        mode: "0644"
      - src: overlays/sway/session/environment
        dst: /etc/sway/environment
        mode: "0644"
      - src: overlays/sway/session/start-sway
        dst: /usr/bin/start-sway
        mode: "0755"
      - src: overlays/sway/scripts/runtime/layered-include
        dst: /usr/libexec/sway/layered-include
        mode: "0755"
      - src: overlays/sway/scripts/runtime/volume-helper
        dst: /usr/libexec/sway/volume-helper
        mode: "0755"

  # Package management using new YAML-based loader
  # Automatically loads packages based on desktop.window_manager or desktop.desktop_environment
  - type: package-loader
    window_manager: sway  # Loaded from overlays/base/packages/window-managers/sway.yml
    include_common: true  # Also loads overlays/base/packages/common/base.yml including Fedora Wayland build deps

  # NOTE: git-clone module type is deprecated pending compilation support.
  # Autotiling installed via uv after package-loader makes it available
  - type: script
    scripts:
      - UV_CACHE_DIR=/tmp/uv-cache uv pip install --system autotiling && rm -rf /tmp/uv-cache

  # Flatpak setup - Add Flathub remote at build time for testing
  # The remote must be present for tests to verify configuration
  - type: script
    scripts:
      - |
        # Add Flathub remote at build time (safe, no package installation)
        # This allows tests to verify the remote is configured
        flatpak remote-add --if-not-exists --system flathub \
          https://dl.flathub.org/repo/flathub.flatpakrepo

        echo "Flathub remote configured at build time"

  # Flatpak setup - Boot-time installation via default-flatpaks module
  # The module creates systemd services that automatically:
  # 1. Set up the Flathub remote on first boot (if not already present)
  # 2. Install all configured flatpak applications
  # See: https://blue-build.org/reference/modules/default-flatpaks/
  - from-file: overlays/base/packages/common/flatpaks.yml

  # Chezmoi dotfiles management
  # Automatically manages dotfiles from the configured repository
  # See: https://blue-build.org/reference/modules/chezmoi/
  - type: chezmoi
    repository: "https://github.com/borninthedark/dotfiles"
    all-users: true
    file-conflict-policy: skip
    run-every: "1d"
    wait-after-boot: "5m"

  # Ensure custom Sway session assets are staged and verified without
  # relying on inline scripts, after packages have been applied.
  - type: script
    scripts:
      - /usr/local/bin/ensure-sway-session

  # Enable image signing support
  - type: signing

  # Plymouth configuration (all images when enabled)
  - type: script
    condition: enable_plymouth == true
    scripts:
      - |
        rm -rf /var/tmp && ln -sf /tmp /var/tmp
        mkdir -p /usr/lib/dracut/dracut.conf.d
        echo 'add_dracutmodules+=" plymouth ostree "' > /usr/lib/dracut/dracut.conf.d/plymouth.conf
        plymouth-set-default-theme bgrt-better-luks
        kver=$(basename /usr/lib/modules/*)
        dracut -vf "/usr/lib/modules/${kver}/initramfs.img" "$kver"

  # Podman Quadlet definitions (container services)
  - type: files
    files:
      - src: overlays/deploy/
        dst: /usr/share/containers/systemd/
        mode: "0644"

  # ZFS kernel module build (DKMS)
  - type: script
    condition: enable_zfs == true
    scripts:
      - /usr/local/bin/build-zfs-kmod

  # ZFS boot automation (modprobe + pool import)
  - type: files
    condition: enable_zfs == true
    files:
      - src: overlays/base/configs-zfs/modules-load.d/zfs.conf
        dst: /etc/modules-load.d/zfs.conf
        mode: "0644"

  - type: systemd
    condition: enable_zfs == true
    system:
      enabled:
        - zfs-import-scan.service
        - zfs.target

  # System services (common to all image types)
  - type: systemd
    system:
      enabled:
        - libvirtd.service
        - seatd.service
        - systemd-resolved.service
        - NetworkManager.service
        - greetd.service
        - bootc-fetch-apply-updates.timer
    user:
      enabled:
        - chezmoi-init.service
        - chezmoi-update.timer
    default-target: graphical.target

  # Note: bluebuild-default-flatpaks-system.service is automatically enabled
  # by the default-flatpaks module when it creates the service files

  # Ensure /var layout matches bootc lint expectations
  - type: script
    scripts:
      - |
        # /var/run should be a symlink to /run for bootc lint
        if [ ! -L /var/run ]; then
          rm -rf /var/run
          ln -s ../run /var/run
        fi

        # Drop build-time cache/log artifacts so tmpfiles can own /var
        rm -f /var/log/dnf5.log /var/log/dnf5.log.[0-9]* || true
        rm -rf /var/cache/dnf /var/cache/libdnf5 /var/cache/etckeeper || true
        rm -rf /var/lib/dnf || true

  # Validation and finalization
  - type: script
    scripts:
      - bootc container lint
      - restorecon -vv /usr/local/bin/tuigreet || true
      - echo "composefs=true" >> /etc/ostree/repo.config || true
