# Systemd drop-in for RKE2 kubeconfig export
# ============================================
#
# This drop-in ensures kubeconfig is exported to the host
# after RKE2 server starts successfully

[Service]
# Wait for RKE2 to generate kubeconfig
ExecStartPost=/bin/bash -c 'while [ ! -f /etc/rancher/rke2/rke2.yaml ]; do sleep 1; done'

# Export kubeconfig to shared mount point for host access
# The host should mount a directory at /mnt/host/kubeconfig
ExecStartPost=/bin/bash -c 'if [ -d /mnt/host/kubeconfig ]; then cp /etc/rancher/rke2/rke2.yaml /mnt/host/kubeconfig/rke2.yaml && chmod 644 /mnt/host/kubeconfig/rke2.yaml; fi'

# Log kubeconfig export status
ExecStartPost=/bin/bash -c 'if [ -f /mnt/host/kubeconfig/rke2.yaml ]; then echo "Kubeconfig exported to host"; else echo "Warning: Host kubeconfig mount not found"; fi'
