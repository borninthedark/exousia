#!/usr/bin/env bash
set -euo pipefail

# Plymouth Theme Configuration Script
# Handles theme selection and bootc kernel arguments
# Initramfs rebuilding is handled separately by dracut hooks

# Color codes (disabled in non-interactive mode)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error()   { echo -e "${RED}✗${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_info()    { echo -e "${BLUE}ℹ${NC} $1"; }

# Configuration
PLYMOUTH_THEME="${PLYMOUTH_THEME:-bgrt-better-luks}"
KARGS_DIR="/usr/lib/bootc/kargs.d"
KARGS_FILE="${KARGS_DIR}/plymouth.toml"

show_usage() {
    cat << EOF
Usage: $0 [COMMAND] [OPTIONS]

Commands:
    set [THEME]     Set Plymouth theme (default: bgrt-better-luks)
    enable          Enable Plymouth boot splash
    disable         Disable Plymouth boot splash (removes kernel args)
    status          Show current Plymouth configuration
    list            List available themes
    help            Show this help message

Environment Variables:
    PLYMOUTH_THEME    Theme to use when no theme argument provided

Examples:
    $0 set bgrt-better-luks    # Set specific theme
    $0 enable                  # Enable Plymouth with current theme
    $0 disable                 # Disable boot splash
    $0 status                  # Show current configuration
    $0 list                    # List available themes

Note: Initramfs rebuilding is handled automatically by dracut hooks.
      Run 'dracut-rebuild' if you need to manually trigger a rebuild.

EOF
}

check_plymouth_installed() {
    if ! command -v plymouth-set-default-theme &>/dev/null; then
        print_error "Plymouth is not installed"
        print_info "Install with: dnf install plymouth plymouth-system-theme plymouth-plugin-two-step"
        return 1
    fi
    return 0
}

check_theme_exists() {
    local theme="${1:-$PLYMOUTH_THEME}"
    if [[ ! -d "/usr/share/plymouth/themes/$theme" ]]; then
        print_error "Theme '$theme' not found"
        print_info "Available themes:"
        list_themes
        return 1
    fi
    return 0
}

list_themes() {
    if [[ -d /usr/share/plymouth/themes ]]; then
        find /usr/share/plymouth/themes -maxdepth 1 -type d -not -name themes -printf "  %f\n" | sort
    else
        echo "  No themes directory found"
    fi
}

set_theme() {
    local theme="${1:-$PLYMOUTH_THEME}"

    print_info "Setting Plymouth theme to: $theme"

    if ! check_plymouth_installed; then
        return 1
    fi

    if ! check_theme_exists "$theme"; then
        return 1
    fi

    # Set the theme
    if plymouth-set-default-theme "$theme"; then
        print_success "Theme set to: $theme"
        print_info "Theme will be active after next boot"
        print_warning "Initramfs will be rebuilt automatically on next kernel install/update"
        return 0
    else
        print_error "Failed to set theme"
        return 1
    fi
}

enable_plymouth() {
    print_info "Enabling Plymouth boot splash..."

    if ! check_plymouth_installed; then
        return 1
    fi

    # Get current theme
    local current_theme
    current_theme=$(plymouth-set-default-theme 2>/dev/null) || current_theme="text"

    if [[ "$current_theme" == "text" ]] || [[ -z "$current_theme" ]]; then
        print_warning "No graphical theme set, using default: $PLYMOUTH_THEME"
        if ! set_theme "$PLYMOUTH_THEME"; then
            return 1
        fi
    else
        print_info "Current theme: $current_theme"
    fi

    # Configure bootc kernel arguments
    print_info "Configuring kernel arguments for Plymouth"
    mkdir -p "$KARGS_DIR"
    cat > "$KARGS_FILE" << 'EOF'
# Plymouth boot splash kernel arguments
kargs = ["splash", "quiet"]
match-architectures = ["x86_64", "aarch64"]
EOF

    print_success "Plymouth enabled with kernel arguments: splash quiet"
    print_info "Changes will take effect after next boot and kernel update"

    return 0
}

disable_plymouth() {
    print_info "Disabling Plymouth boot splash..."

    # Remove kernel arguments
    if [[ -f "$KARGS_FILE" ]]; then
        rm -f "$KARGS_FILE"
        print_success "Removed Plymouth kernel arguments"
    else
        print_info "Plymouth kernel arguments not found (already disabled)"
    fi

    print_info "Plymouth theme remains installed but boot splash disabled"
    print_info "To fully remove Plymouth: dnf remove plymouth"

    return 0
}

show_status() {
    echo "Plymouth Configuration Status"
    echo "=============================="
    echo

    # Check if plymouth is installed
    if command -v plymouth-set-default-theme &>/dev/null; then
        echo -e "Plymouth Package: ${GREEN}Installed${NC}"

        # Get current theme
        local current_theme
        current_theme=$(plymouth-set-default-theme 2>/dev/null) || current_theme="unknown"
        echo "Current Theme: $current_theme"
    else
        echo -e "Plymouth Package: ${RED}Not Installed${NC}"
        return 0
    fi
    echo

    # Check kernel arguments
    if [[ -f "$KARGS_FILE" ]]; then
        echo -e "Boot Splash: ${GREEN}Enabled${NC}"
        echo "Kernel Args File: $KARGS_FILE"
        if [[ -r "$KARGS_FILE" ]]; then
            echo "Configured Args:"
            grep '^kargs' "$KARGS_FILE" | sed 's/^/  /'
        fi
    else
        echo -e "Boot Splash: ${YELLOW}Disabled${NC} (no kernel arguments configured)"
    fi
    echo

    # Check theme directory
    local theme_dir="/usr/share/plymouth/themes/$current_theme"
    if [[ -d "$theme_dir" ]]; then
        echo -e "Theme Directory: ${GREEN}Present${NC} ($theme_dir)"
    else
        echo -e "Theme Directory: ${RED}Missing${NC}"
    fi
    echo

    # Check dracut configuration
    if [[ -f /usr/lib/dracut/dracut.conf.d/plymouth.conf ]]; then
        echo -e "Dracut Config: ${GREEN}Present${NC}"
    else
        echo -e "Dracut Config: ${YELLOW}Missing${NC} (will be created on initramfs rebuild)"
    fi
    echo

    # Show initramfs status
    local kver
    if [[ -d /usr/lib/modules ]]; then
        kver=$(cd /usr/lib/modules && echo * | awk '{print $1}')
        if [[ -f "/usr/lib/modules/$kver/initramfs.img" ]]; then
            local initramfs_date
            initramfs_date=$(stat -c %y "/usr/lib/modules/$kver/initramfs.img" 2>/dev/null | cut -d. -f1)
            echo "Initramfs: Present ($kver)"
            echo "  Last Built: $initramfs_date"
        fi
    fi
}

main() {
    local command="${1:-help}"

    case "$command" in
        set)
            shift
            set_theme "$@"
            ;;
        enable)
            enable_plymouth
            ;;
        disable)
            disable_plymouth
            ;;
        status)
            show_status
            ;;
        list)
            echo "Available Plymouth Themes:"
            list_themes
            ;;
        help|--help|-h)
            show_usage
            ;;
        *)
            print_error "Unknown command: $command"
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
