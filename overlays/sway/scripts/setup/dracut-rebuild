#!/usr/bin/env bash
set -euo pipefail

# Dracut Initramfs Rebuild Script
# Handles initramfs regeneration with proper Plymouth support

# Color codes (disabled in non-interactive mode)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error()   { echo -e "${RED}✗${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_info()    { echo -e "${BLUE}ℹ${NC} $1"; }

# Configuration
DRACUT_CONF_DIR="/usr/lib/dracut/dracut.conf.d"
PLYMOUTH_CONF="${DRACUT_CONF_DIR}/plymouth.conf"

show_usage() {
    cat << EOF
Usage: $0 [OPTIONS] [KERNEL_VERSION]

Options:
    -f, --force     Force rebuild even if initramfs exists
    -v, --verbose   Verbose dracut output
    -h, --help      Show this help message

Arguments:
    KERNEL_VERSION  Specific kernel version to rebuild (default: current)

Examples:
    $0                          # Rebuild initramfs for current kernel
    $0 6.8.5-301.fc40.x86_64   # Rebuild for specific kernel
    $0 -f                       # Force rebuild
    $0 -v                       # Verbose output

Note: This script is called automatically during kernel installation.

EOF
}

ensure_dracut_config() {
    print_info "Ensuring dracut configuration..."

    # Create dracut config directory if needed
    mkdir -p "$DRACUT_CONF_DIR"

    # Create Plymouth dracut configuration if it doesn't exist
    if [[ ! -f "$PLYMOUTH_CONF" ]]; then
        print_info "Creating Plymouth dracut configuration"
        cat > "$PLYMOUTH_CONF" << 'EOF'
# Plymouth configuration for dracut
# Automatically includes Plymouth modules in initramfs

add_dracutmodules+=" plymouth ostree "
EOF
        print_success "Created: $PLYMOUTH_CONF"
    else
        print_info "Plymouth dracut config already exists"
    fi
}

setup_var_tmp() {
    # Ensure /var/tmp is properly set up (required for some dracut operations)
    if [[ -d /var/tmp ]] && [[ ! -L /var/tmp ]]; then
        print_info "Converting /var/tmp to symlink"
        rm -rf /var/tmp
        ln -sf /tmp /var/tmp
        print_success "/var/tmp -> /tmp"
    elif [[ ! -e /var/tmp ]]; then
        print_info "Creating /var/tmp symlink"
        ln -sf /tmp /var/tmp
        print_success "/var/tmp -> /tmp"
    fi
}

get_kernel_version() {
    local kver="${1:-}"

    if [[ -n "$kver" ]]; then
        # Use provided kernel version
        if [[ ! -d "/usr/lib/modules/$kver" ]]; then
            print_error "Kernel version not found: $kver"
            print_info "Available kernels:"
            find /usr/lib/modules/ -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sed 's/^/  /' || echo "  None found"
            return 1
        fi
        echo "$kver"
    else
        # Detect current kernel version
        if [[ -d /usr/lib/modules ]]; then
            kver=$(cd /usr/lib/modules && echo * | awk '{print $1}')
            if [[ "$kver" != "*" ]] && [[ -d "/usr/lib/modules/$kver" ]]; then
                echo "$kver"
            else
                print_error "No kernel modules found in /usr/lib/modules"
                return 1
            fi
        else
            print_error "/usr/lib/modules directory not found"
            return 1
        fi
    fi
}

rebuild_initramfs() {
    local kver="$1"
    local force="$2"
    local verbose="$3"

    local initramfs_path="/usr/lib/modules/$kver/initramfs.img"

    print_info "Kernel version: $kver"
    print_info "Initramfs path: $initramfs_path"

    # Check if initramfs already exists
    if [[ -f "$initramfs_path" ]] && [[ "$force" != "true" ]]; then
        print_warning "Initramfs already exists. Use --force to rebuild."
        print_info "Existing file: $initramfs_path"
        return 0
    fi

    # Setup environment
    ensure_dracut_config
    setup_var_tmp

    # Build dracut command
    local dracut_cmd="dracut"
    if [[ "$verbose" == "true" ]]; then
        dracut_cmd="$dracut_cmd -v"
    fi
    dracut_cmd="$dracut_cmd -f $initramfs_path $kver"

    print_info "Running: $dracut_cmd"
    print_info "This may take a moment..."

    # Run dracut
    if eval "$dracut_cmd"; then
        print_success "Initramfs rebuilt successfully"

        # Show file info
        if [[ -f "$initramfs_path" ]]; then
            local size
            size=$(du -h "$initramfs_path" | cut -f1)
            print_info "Size: $size"
        fi

        return 0
    else
        print_error "Failed to rebuild initramfs"
        return 1
    fi
}

list_kernels() {
    echo "Installed Kernels:"
    if [[ -d /usr/lib/modules ]]; then
        for kver in /usr/lib/modules/*; do
            if [[ -d "$kver" ]]; then
                local name
                name=$(basename "$kver")
                local initramfs="/usr/lib/modules/$name/initramfs.img"
                if [[ -f "$initramfs" ]]; then
                    echo -e "  ${GREEN}✓${NC} $name (initramfs present)"
                else
                    echo -e "  ${YELLOW}✗${NC} $name (no initramfs)"
                fi
            fi
        done
    else
        echo "  No kernels found"
    fi
}

main() {
    local force="false"
    local verbose="false"
    local kver=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force)
                force="true"
                shift
                ;;
            -v|--verbose)
                verbose="true"
                shift
                ;;
            -l|--list)
                list_kernels
                exit 0
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            -*)
                print_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
            *)
                kver="$1"
                shift
                ;;
        esac
    done

    # Get kernel version
    if ! kver=$(get_kernel_version "$kver"); then
        exit 1
    fi

    # Rebuild initramfs
    if rebuild_initramfs "$kver" "$force" "$verbose"; then
        print_success "Dracut rebuild completed successfully"
        exit 0
    else
        print_error "Dracut rebuild failed"
        exit 1
    fi
}

main "$@"
