# Exousia Sway Bootc Build Configuration
# Uses the new package structure with DE/WM selection

name: exousia-sway-bootc
description: Custom Fedora bootc image with Sway desktop environment
image-version: 43

# Base image configuration
base-image: quay.io/fedora/fedora-bootc:43
image-type: fedora-bootc

# Desktop environment selection
# Use either 'window_manager' or 'desktop_environment', not both
desktop:
  window_manager: sway
  # desktop_environment: gnome  # Options: gnome
  include_common: true  # Include common base packages

# Container metadata
labels:
  org.opencontainers.image.title: "Exousia Sway Bootc"
  org.opencontainers.image.description: "Custom Fedora bootc image with Sway desktop environment"
  org.opencontainers.image.source: "https://github.com/borninthedark/exousia"
  org.opencontainers.image.licenses: "MIT"
  maintainer: "uryu"

# Build configuration
build:
  enable_plymouth: true

# Modules define the build steps
modules:
  # System users configuration
  - type: files
    files:
      - src: overlays/base/sysusers/bootc.conf
        dst: /usr/lib/sysusers.d/bootc.conf
        mode: "0644"

  # Initialize system users
  - type: script
    scripts:
      - |
        test -f /etc/passwd || touch /etc/passwd
        test -f /etc/group  || touch /etc/group
      - systemd-sysusers || true
      - |
        set -e
        systemd-sysusers --root=/ /usr/lib/sysusers.d/bootc.conf
        mkdir -p /var/lib/greeter /var/lib/greetd /var/lib/rtkit
        chown -R 241:241 /var/lib/greeter || true
        chown -R 240:240 /var/lib/greetd || true

  # Greetd configuration (bootc-specific)
  - type: script
    condition: image-type == "fedora-bootc"
    scripts:
      - |
        mkdir -p /etc/greetd
        printf '[security]\nuser = "greetd"\n\n[default]\n' > /etc/greetd/config.toml

  # Container authentication
  - type: files
    files:
      - src: containers-auth.conf
        dst: /usr/lib/tmpfiles.d/containers-auth.conf
        mode: "0644"
      - src: ./bootc-secrets/auth.json
        dst: /usr/lib/container-auth.json
        mode: "0600"

  - type: script
    scripts:
      - ln -sfr /usr/lib/container-auth.json /etc/ostree/auth.json

  # Directory structure (bootc only)
  - type: script
    condition: image-type == "fedora-bootc"
    scripts:
      - |
        mkdir -p /var/roothome /var/opt /usr/lib/extensions
        rm -rf /opt
        ln -sf /var/opt /opt

  # Plymouth theme files (toggleable per image type)
  - type: files
    condition: enable_plymouth == true
    files:
      - src: overlays/sway/configs/plymouth/themes/bgrt-better-luks/
        dst: /usr/share/plymouth/themes/bgrt-better-luks/
        mode: "0644"

  # Custom repositories
  - type: files
    files:
      - src: overlays/sway/repos/
        dst: /etc/yum.repos.d/
        mode: "0644"

  # Base configurations (PAM, polkit, tmpfiles)
  - type: files
    files:
      - src: overlays/base/configs/
        dst: /etc/
        mode: "0644"

  # Sway configurations (greetd, sway, swaylock)
  - type: files
    files:
      - src: overlays/sway/configs/
        dst: /etc/
        mode: "0644"

  # Base scripts
  - type: files
    files:
      - src: overlays/base/tools/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway setup scripts
  - type: files
    files:
      - src: overlays/sway/scripts/setup/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway runtime scripts
  - type: files
    files:
      - src: overlays/sway/scripts/runtime/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway session files and helper scripts
  # Always install these for the fedora-bootc Sway image to ensure
  # desktop entries and helper scripts are present even if the
  # window_manager variable is not propagated to module conditions.
  - type: files
    files:
      - src: overlays/sway/session/sway.desktop
        dst: /usr/share/wayland-sessions/sway.desktop
        mode: "0644"
      - src: overlays/sway/session/environment
        dst: /etc/sway/environment
        mode: "0644"
      - src: overlays/sway/session/start-sway
        dst: /usr/bin/start-sway
        mode: "0755"
      - src: overlays/sway/scripts/runtime/layered-include
        dst: /usr/libexec/sway/layered-include
        mode: "0755"
      - src: overlays/sway/scripts/runtime/volume-helper
        dst: /usr/libexec/sway/volume-helper
        mode: "0755"

  # Package management with new loader
  - type: package-loader
    window_manager: sway
    include_common: true

  # Re-stage and validate the Sway session assets via a dedicated helper
  # instead of inline shell, after package installation.
  - type: script
    scripts:
      - /usr/local/bin/ensure-sway-session

  # Flatpak setup
  - type: script
    scripts:
      - |
        set -euxo pipefail

        # Add Flathub remote at build time (safe, no package installation)
        # This allows tests to verify the remote is configured
        flatpak remote-add --if-not-exists --system flathub \
          https://dl.flathub.org/repo/flathub.flatpakrepo

        echo "âœ“ Flathub remote configured at build time"

  # Chezmoi dotfiles management
  - type: chezmoi
    repository: "https://github.com/borninthedark/dotfiles"
    all-users: true
    file-conflict-policy: skip
    run-every: "1d"
    wait-after-boot: "5m"

  # Enable chezmoi systemd user services for all users
  - type: systemd
    system:
      enabled:
        - bootc-fetch-apply-updates.timer
    user:
      enabled:
        - chezmoi-init.service
        - chezmoi-update.timer

  # Plymouth configuration (all images when enabled)
  - type: script
    condition: enable_plymouth == true
    scripts:
      - |
        rm -rf /var/tmp && ln -sf /tmp /var/tmp
        mkdir -p /usr/lib/dracut/dracut.conf.d
        echo 'add_dracutmodules+=" plymouth ostree "' > /usr/lib/dracut/dracut.conf.d/plymouth.conf
        plymouth-set-default-theme bgrt-better-luks
        kver=$(basename /usr/lib/modules/*)
        dracut -vf /usr/lib/modules/$kver/initramfs.img $kver

  # Bootc-specific Plymouth kargs
  - type: script
    condition: image-type == "fedora-bootc" && enable_plymouth == true
    scripts:
      - |
        mkdir -p /usr/lib/bootc/kargs.d
        printf 'kargs = ["splash", "quiet"]\nmatch-architectures = ["x86_64", "aarch64"]\n' > /usr/lib/bootc/kargs.d/plymouth.toml

  # System services (bootc-specific)
  - type: systemd
    condition: image-type == "fedora-bootc"
    system:
      enabled:
        - greetd.service
        - libvirtd.service
        - systemd-resolved.service
        - NetworkManager.service
    default-target: graphical.target

  # Validation and finalization
  - type: script
    scripts:
      - bootc container lint
      - restorecon -vv /usr/local/bin/tuigreet
      - echo "composefs=true" >> /etc/ostree/repo.config || true
