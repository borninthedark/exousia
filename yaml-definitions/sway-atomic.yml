# Exousia Sway Atomic Build Configuration
# Simplified YAML for testing transpiler with fedora-sway-atomic base

name: exousia-sway-atomic
description: Custom Fedora Sway Atomic image with opinionated package selection
image-version: 43

# Base image configuration
base-image: quay.io/fedora/fedora-sway-atomic:43
image-type: fedora-sway-atomic

# Container metadata
labels:
  org.opencontainers.image.title: "Exousia Sway Atomic Desktop"
  org.opencontainers.image.description: "Custom Fedora bootc image with Sway desktop and opinionated package selection"
  org.opencontainers.image.source: "https://github.com/borninthedark/exousia"
  org.opencontainers.image.licenses: "MIT"
  maintainer: "uryu"

# Build configuration
build:
  enable_plymouth: true

# Modules define the build steps
modules:
  # System users configuration (rtkit only for atomic, no greetd needed)
  - type: files
    files:
      - src: overlays/base/sysusers/atomic.conf
        dst: /usr/lib/sysusers.d/atomic.conf
        mode: "0644"

  # Initialize system users
  - type: script
    scripts:
      - |
        test -f /etc/passwd || touch /etc/passwd
        test -f /etc/group  || touch /etc/group
      - systemd-sysusers || true
      - |
        set -e
        systemd-sysusers --root=/ /usr/lib/sysusers.d/atomic.conf
        mkdir -p /var/lib/rtkit

  # SDDM configuration (atomic images include SDDM)
  # Note: SDDM config dirs don't exist on disk yet - uncomment when added
  # - type: files
  #   files:
  #     - src: overlays/sway/configs/sddm/sddm.conf.d/
  #       dst: /etc/sddm.conf.d/
  #       mode: "0644"

  # SDDM theme bundles (will be extracted by setup script)
  # - type: files
  #   files:
  #     - src: overlays/sway/configs/sddm/themes/
  #       dst: /tmp/sddm-themes-source/
  #       mode: "0644"

  # Container authentication
  - type: files
    files:
      - src: containers-auth.conf
        dst: /usr/lib/tmpfiles.d/containers-auth.conf
        mode: "0644"

  # Plymouth theme files (toggleable)
  - type: files
    condition: enable_plymouth == true
    files:
      - src: overlays/sway/configs/plymouth/themes/bgrt-better-luks/
        dst: /usr/share/plymouth/themes/bgrt-better-luks/
        mode: "0644"

  # Custom repositories
  - type: files
    files:
      - src: overlays/sway/repos/
        dst: /etc/yum.repos.d/
        mode: "0644"

  # Base configurations (PAM, polkit, tmpfiles)
  - type: files
    files:
      - src: overlays/base/configs/
        dst: /etc/
        mode: "0644"

  # Sway configurations (greetd, sway, swaylock)
  - type: files
    files:
      - src: overlays/sway/configs/
        dst: /etc/
        mode: "0644"

  # Base scripts
  - type: files
    files:
      - src: overlays/base/tools/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway setup scripts
  - type: files
    files:
      - src: overlays/sway/scripts/setup/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway runtime scripts
  - type: files
    files:
      - src: overlays/sway/scripts/runtime/
        dst: /usr/local/bin/
        mode: "0755"

  # Sway helper scripts
  - type: files
    files:
      - src: overlays/sway/scripts/runtime/layered-include
        dst: /usr/libexec/sway/layered-include
        mode: "0755"

  # Extract and configure SDDM themes
  - type: sddm-themes
    source: /tmp/sddm-themes-source
    destination: /usr/share/sddm/themes
    config: /etc/sddm.conf.d/99-theme.conf

  # Create base package list
  - type: script
    scripts:
      - |
        mkdir -p /usr/local/share/fedora-sway-atomic
        if [ -f /usr/share/rpm-ostree/treefile.json ]; then
          jq -r .packages[] /usr/share/rpm-ostree/treefile.json > /usr/local/share/fedora-sway-atomic/packages-base
        else
          touch /usr/local/share/fedora-sway-atomic/packages-base
        fi

  # Package management
  - type: rpm-ostree
    install-dnf5: true
    repos:
      - https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-43.noarch.rpm
      - https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-43.noarch.rpm

    config-manager:
      - fedora-cisco-openh264

    install-conditional:
        - condition: enable_plymouth == true
          packages:
            # Boot Splash
            - plymouth
            - plymouth-system-theme
            - plymouth-plugin-two-step

    # Custom packages (sway already included in base)
    install:
      # Core Utilities
      - kitty
      - neovim
      - flatpak
      - wob
      - rtkit
      - cargo
      - git
      - swaync
      - fuzzel
      - htop
      - nwg-look
      - btop
      - etckeeper
      - fastfetch
      - glances
      # Audio & Media
      - mpd
      - ranger
      # Tools
      - bat
      - wf-recorder
      - lsd
      - fzf
      - direnv
      - distrobox
      - wireguard-tools
      # Virtualization
      - virt-manager
      - qemu-kvm
      - libvirt
      # Security
      - pam-u2f
      - pamu2fcfg
      - lynis
      - openssl
      # Developer Tools
      - ripgrep
      - zoxide
      # Extra
      - cava
      - zsh
      - zsh-autosuggestions
      - zsh-syntax-highlighting

    remove:
      - firefox-langpacks

    upgrade: true

  # Flatpak setup
  - type: script
    scripts:
      - |
        set -euxo pipefail

        # Add Flathub remote at build time (safe, no package installation)
        # This allows tests to verify the remote is configured
        flatpak remote-add --if-not-exists --system flathub \
          https://dl.flathub.org/repo/flathub.flatpakrepo

        echo "âœ“ Flathub remote configured at build time"

  # Chezmoi dotfiles management
  - type: chezmoi
    repository: "https://github.com/borninthedark/dotfiles"
    all-users: true
    file-conflict-policy: skip
    run-every: "1d"
    wait-after-boot: "5m"

  # Enable systemd services
  - type: systemd
    system:
      enabled:
        - bootc-fetch-apply-updates.timer
        - libvirtd.service
    user:
      enabled:
        - chezmoi-init.service
        - chezmoi-update.timer

  # Plymouth configuration (all images when enabled)
  - type: script
    condition: enable_plymouth == true
    scripts:
      - |
        rm -rf /var/tmp && ln -sf /tmp /var/tmp
        mkdir -p /usr/lib/dracut/dracut.conf.d
        echo 'add_dracutmodules+=" plymouth ostree "' > /usr/lib/dracut/dracut.conf.d/plymouth.conf
        plymouth-set-default-theme bgrt-better-luks
        kver=$(basename /usr/lib/modules/*)
        dracut -vf /usr/lib/modules/$kver/initramfs.img $kver

  # Services - skip for sway-atomic (defaults already set)
  - type: script
    scripts:
      - echo "==> Skipping explicit service enablement - sway-atomic provides defaults"

  # Validation and finalization
  - type: script
    scripts:
      - bootc container lint
      - echo "composefs=true" >> /etc/ostree/repo.config || true
