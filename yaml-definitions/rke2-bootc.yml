# Exousia RKE2 Bootc Build Configuration
# Minimal bootc image with RKE2 Kubernetes, no desktop environment
# For dedicated Kubernetes nodes and VM-based cluster deployments

name: exousia-rke2-bootc
description: Minimal Fedora bootc image with RKE2 Kubernetes for immutable infrastructure
image-version: 43

# Base image configuration
base-image: quay.io/fedora/fedora-bootc:43
image-type: fedora-bootc

# No desktop environment - server/minimal configuration
desktop:
  window_manager: null
  desktop_environment: null
  include_common: false  # Minimal system only

# Container metadata
labels:
  org.opencontainers.image.title: "Exousia RKE2"
  org.opencontainers.image.description: "Minimal Fedora bootc with RKE2 Kubernetes"
  org.opencontainers.image.source: "https://github.com/borninthedark/exousia"
  org.opencontainers.image.licenses: "MIT"
  maintainer: "uryu"

# Build configuration
build:
  enable_plymouth: false  # No boot splash for server images
  enable_rke2: true       # RKE2 is the primary purpose

# Modules define the build steps
modules:
  # System users configuration
  - type: files
    files:
      - src: sysusers/bootc.conf
        dst: /usr/lib/sysusers.d/bootc.conf
        mode: "0644"

  # Initialize system users
  - type: script
    scripts:
      - |
        test -f /etc/passwd || touch /etc/passwd
        test -f /etc/group  || touch /etc/group
        systemd-sysusers || true
        systemd-sysusers --root=/ /usr/lib/sysusers.d/bootc.conf

  # Container authentication
  - type: files
    files:
      - src: containers-auth.conf
        dst: /usr/lib/tmpfiles.d/containers-auth.conf
        mode: "0644"
      - src: ./bootc-secrets/auth.json
        dst: /usr/lib/container-auth.json
        mode: "0600"

  - type: script
    scripts:
      - ln -sfr /usr/lib/container-auth.json /etc/ostree/auth.json

  # Directory structure
  - type: script
    scripts:
      - |
        mkdir -p /var/roothome /var/opt /usr/lib/extensions
        rm -rf /opt
        ln -sf /var/opt /opt

  # Custom repositories
  - type: files
    files:
      - src: custom-repos/
        dst: /etc/yum.repos.d/
        mode: "0644"

  # Kubernetes repository for kubectl (overwrites any existing config)
  - type: script
    scripts:
      - |
        cat <<'EOF' > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=https://pkgs.k8s.io/core:/stable:/v1.34/rpm/
        enabled=1
        gpgcheck=1
        gpgkey=https://pkgs.k8s.io/core:/stable:/v1.34/rpm/repodata/repomd.xml.key
        EOF

  # RKE2 configuration files
  - type: files
    files:
      - src: custom-configs/rke2/
        dst: /etc/rancher/rke2/
        mode: "0644"

  # Custom scripts (including RKE2 helpers)
  - type: files
    files:
      - src: custom-scripts/
        dst: /usr/local/bin/
        mode: "0755"

  # Install kubectl from the Kubernetes repository
  - type: script
    scripts:
      - |
        dnf install -y kubectl
        dnf clean all --enablerepo='*'

  # RKE2 management CLI (Python)
  - type: files
    files:
      - src: tools/rke2_ops.py
        dst: /usr/local/bin/rke2_ops
        mode: "0755"

  # ============================================================================
  # RKE2 Kubernetes Installation
  # ============================================================================

  # RKE2 installation
  - type: script
    scripts:
      - |
        # Install RKE2 using official install script
        # Binaries go to /var/lib/rancher/rke2/bin for canonical access
        INSTALL_RKE2_BIN_DIR=/var/lib/rancher/rke2/bin \
          curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=server sh -

        # Ensure kubectl is staged even if the installer omitted it
        mkdir -p /var/lib/rancher/rke2/bin
        if [ ! -x /var/lib/rancher/rke2/bin/kubectl ] && [ -x /usr/bin/kubectl ]; then
          install -m 0755 /usr/bin/kubectl /var/lib/rancher/rke2/bin/kubectl
        fi

        if [ -x /var/lib/rancher/rke2/bin/kubectl ] && [ ! -e /usr/local/bin/kubectl ]; then
          ln -s /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/kubectl
        fi

        if [ ! -x /var/lib/rancher/rke2/bin/kubectl ]; then
          echo "✗ RKE2 kubectl not found after install" >&2
          exit 1
        fi

        # Ensure canonical RKE2 binary path exists for tests
        if [ -x /var/lib/rancher/rke2/bin/rke2 ] && [ ! -e /usr/local/bin/rke2 ]; then
          ln -s /var/lib/rancher/rke2/bin/rke2 /usr/local/bin/rke2
        elif [ -x /usr/bin/rke2 ] && [ ! -e /usr/local/bin/rke2 ]; then
          ln -s /usr/bin/rke2 /usr/local/bin/rke2
        fi

        if [ ! -x /usr/local/bin/rke2 ]; then
          echo "✗ RKE2 binary missing after install" >&2
          exit 1
        fi

        # Ensure kubectl from the RKE2 bundle is present and easy to use
        if [ -x /var/lib/rancher/rke2/bin/kubectl ] && [ ! -e /usr/local/bin/kubectl ]; then
          ln -s /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/kubectl
        fi

        if [ ! -x /var/lib/rancher/rke2/bin/kubectl ]; then
          echo "✗ RKE2 kubectl not found after install" >&2
          exit 1
        fi

  # RKE2 systemd drop-in directory
  - type: script
    scripts:
      - mkdir -p /etc/systemd/system/rke2-server.service.d

  # RKE2 firewall configuration
  - type: script
    scripts:
      - |
        # Open required RKE2 ports
        firewall-offline-cmd --add-port=6443/tcp    # Kubernetes API
        firewall-offline-cmd --add-port=9345/tcp    # RKE2 supervisor API
        firewall-offline-cmd --add-port=10250/tcp   # Kubelet
        firewall-offline-cmd --add-port=2379-2380/tcp  # etcd

  # Note: /mnt/host/* mount points are created at runtime by cloud-init
  # See: k8s/rke2/cloud-init.yaml for runtime directory creation

  # RKE2 SELinux contexts
  - type: script
    scripts:
      - |
        mkdir -p /var/lib/rancher/rke2
        semanage fcontext -a -t container_var_lib_t "/var/lib/rancher/rke2(/.*)?" || true
        restorecon -R /var/lib/rancher/rke2 || true

  # RKE2 bootc kargs
  - type: script
    scripts:
      - |
        mkdir -p /usr/lib/bootc/kargs.d
        echo 'kargs = ["systemd.unified_cgroup_hierarchy=1", "swapaccount=1"]' > /usr/lib/bootc/kargs.d/99-rke2.toml

  # RKE2 MOTD
  - type: script
    scripts:
      - |
        cat > /etc/motd << 'EOF'
        ╔═══════════════════════════════════════════════════════════╗
        ║           Exousia RKE2 - Immutable Kubernetes             ║
        ╠═══════════════════════════════════════════════════════════╣
        ║                                                           ║
        ║  RKE2 Server: systemctl status rke2-server               ║
        ║  RKE2 Ops:    rke2_ops --help                            ║
        ║  VM Status:   rke2_ops vm status                         ║
        ║  Kubeconfig:  rke2_ops kubeconfig                        ║
        ║                                                           ║
        ║  Upgrade:     bootc upgrade && systemctl reboot          ║
        ║  Rollback:    bootc rollback && systemctl reboot         ║
        ║                                                           ║
        ╚═══════════════════════════════════════════════════════════╝
        EOF

  # System services
  - type: systemd
    system:
      enabled:
        - systemd-resolved.service
        - NetworkManager.service
        - rke2-server.service
    default-target: multi-user.target  # No graphical target for server

  # Ensure /var layout matches bootc lint expectations
  - type: script
    scripts:
      - |
        set -euxo pipefail

        if [ ! -L /var/run ]; then
          rm -rf /var/run
          ln -s ../run /var/run
        fi

        rm -f /var/log/dnf5.log /var/log/dnf5.log.[0-9]* || true
        rm -rf /var/cache/dnf /var/cache/libdnf5 /var/cache/etckeeper || true
        rm -rf /var/lib/dnf || true

  # Validation and finalization
  - type: script
    scripts:
      - bootc container lint
      - restorecon -vv /usr/local/bin/rke2_ops || true
      - test -f /usr/local/bin/rke2 && echo "RKE2 installed" || echo "RKE2 not installed"
      - |
        rpm -q \
          curl \
          iptables \
          container-selinux \
          policycoreutils-python-utils \
          cryptsetup \
          python3
      - echo "composefs=true" >> /etc/ostree/repo.config || true
