#!/usr/bin/env bash
set -euo pipefail

# Accept version and image type from arguments
target_version="${1:-}"
target_image_type="${2:-}"

if [[ -z "$target_version" || -z "$target_image_type" ]]; then
  echo "Usage: $0 <version> <image_type>"
  exit 1
fi

# Fedora Version Switcher for Bootc Images
# Allows switching between Fedora versions and base image types for building custom bootc images
# Based on official Fedora bootc documentation

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Look for Containerfile in project root (parent of custom-scripts)
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
VERSION_FILE="${PROJECT_ROOT}/.fedora-version"

# Current supported Fedora versions (as of November 2025)
SUPPORTED_VERSIONS=("42" "43" "44" "rawhide")
CURRENT_VERSION=""
CURRENT_IMAGE_TYPE=""

# Available base image types from official Fedora bootc project
declare -A IMAGE_TYPES=(
    ["fedora-bootc"]="quay.io/fedora/fedora-bootc"
    ["fedora-sway-atomic"]="quay.io/fedora/fedora-sway-atomic"
)

declare -A IMAGE_DESCRIPTIONS=(
    ["fedora-bootc"]="Minimal server base - requires desktop packages"
    ["fedora-sway-atomic"]="Full Sway desktop - pre-configured"
)

# Color codes for output (disabled in CI)
if [[ "${CI:-false}" == "true" ]]; then
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
fi

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║   Fedora Bootc Version Switcher       ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo
}

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error()   { echo -e "${RED}✗${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_info()    { echo -e "${BLUE}ℹ${NC} $1"; }

save_version() {
    local version=$1
    local image_type=$2
    echo "${version}:${image_type}" > "$VERSION_FILE"
}

detect_current_config() {
    if [[ -f "$VERSION_FILE" ]]; then
        if [[ -s "$VERSION_FILE" ]]; then
            CURRENT_VERSION=$(cut -d: -f1 < "$VERSION_FILE")
            CURRENT_IMAGE_TYPE=$(cut -d: -f2 < "$VERSION_FILE")
            if [[ -n "$CURRENT_VERSION" && -n "$CURRENT_IMAGE_TYPE" ]]; then
                return 0
            fi
        fi
    fi

    # Try to find a Containerfile variant (atomic or bootc)
    local containerfile=""
    if [[ -f "${PROJECT_ROOT}/Containerfile.atomic" ]]; then
        containerfile="${PROJECT_ROOT}/Containerfile.atomic"
    elif [[ -f "${PROJECT_ROOT}/Containerfile.bootc" ]]; then
        containerfile="${PROJECT_ROOT}/Containerfile.bootc"
    fi

    if [[ -z "$containerfile" ]]; then
        print_error "Neither .fedora-version nor Containerfile.atomic/Containerfile.bootc found"
        exit 1
    fi

    local version_arg
    version_arg=$(grep "^ARG FEDORA_VERSION=" "$containerfile" | cut -d= -f2)
    local type_arg
    type_arg=$(grep "^ARG IMAGE_TYPE=" "$containerfile" | cut -d= -f2)

    if [[ -n "$version_arg" && -n "$type_arg" ]]; then
        CURRENT_VERSION="$version_arg"
        CURRENT_IMAGE_TYPE="$type_arg"
        print_warning "No .fedora-version file found, using defaults from $(basename "$containerfile")"
        print_warning "Creating .fedora-version file..."
        save_version "$CURRENT_VERSION" "$CURRENT_IMAGE_TYPE"
    else
        print_error "Could not detect configuration from .fedora-version or Containerfile variants"
        CURRENT_VERSION="unknown"
        CURRENT_IMAGE_TYPE="unknown"
    fi
}

list_versions() {
    echo "Currently using: ${GREEN}Fedora $CURRENT_VERSION${NC} (${CURRENT_IMAGE_TYPE})"
    echo "  ${YELLOW}▸${NC} ${IMAGE_DESCRIPTIONS[$CURRENT_IMAGE_TYPE]:-Unknown image type}"
    echo
    echo "═══════════════════════════════════════════════════════════"
    echo "Available Fedora Versions:"
    echo "═══════════════════════════════════════════════════════════"
    echo
    echo "  ${BLUE}42${NC}  Fedora 42 (Released Apr 2025) ${YELLOW}← Supported${NC}"
    echo
    echo "  ${BLUE}43${NC}  Fedora 43 (Released Oct 2025) ${GREEN}← Current Stable${NC}"
    echo
    echo "  ${BLUE}44${NC}  Fedora 44 (Upcoming, expected Apr 2026)"
    echo
    echo "  ${BLUE}rawhide${NC}  Rawhide (Rolling development)"
    echo
    echo "═══════════════════════════════════════════════════════════"
    echo "Available Base Image Types:"
    echo "═══════════════════════════════════════════════════════════"
    echo
    echo "  ${BLUE}fedora-bootc${NC} - Minimal Server Base"
    echo "  ${BLUE}fedora-sway-atomic${NC} - Full Sway Desktop"
    echo
}

validate_version() {
    local version=$1
    for v in "${SUPPORTED_VERSIONS[@]}"; do
        if [[ "$v" == "$version" ]]; then return 0; fi
    done
    return 1
}

validate_image_type() {
    local type=$1
    [[ -n "${IMAGE_TYPES[$type]:-}" ]]
}

backup_containerfile() {
    local containerfile=""
    if [[ -f "${PROJECT_ROOT}/Containerfile.atomic" ]]; then
        containerfile="${PROJECT_ROOT}/Containerfile.atomic"
    elif [[ -f "${PROJECT_ROOT}/Containerfile.bootc" ]]; then
        containerfile="${PROJECT_ROOT}/Containerfile.bootc"
    fi

    if [[ -z "$containerfile" ]]; then
        print_warning "No Containerfile found to backup"
        return 0
    fi

    local backup_file
    backup_file="${containerfile}.bak.$(date +%Y%m%d_%H%M%S)"
    cp "$containerfile" "$backup_file"
    print_info "Backup created: $backup_file"
}

switch_version() {
    local target_version=$1
    local target_image_type="${2:-$CURRENT_IMAGE_TYPE}"
    
    if [[ "$target_version" == "$CURRENT_VERSION" && "$target_image_type" == "$CURRENT_IMAGE_TYPE" ]]; then
        print_warning "Already using Fedora $target_version ($target_image_type)"
        exit 0
    fi
    
    print_info "Switching configuration:"
    echo "  From: Fedora $CURRENT_VERSION ($CURRENT_IMAGE_TYPE)"
    echo "  To:   Fedora $target_version ($target_image_type)"
    
    if [[ "$target_image_type" == "fedora-bootc" ]]; then
        print_warning "Switching to fedora-bootc will install desktop packages and enable services"
    elif [[ "$target_image_type" == "fedora-sway-atomic" ]]; then
        print_info "Switching to fedora-sway-atomic will skip packages.desktop and service enablement"
    fi
    
    if [[ "${CI:-false}" != "true" ]]; then
        backup_containerfile
    fi
    
    save_version "$target_version" "$target_image_type"
    CURRENT_IMAGE_TYPE="$target_image_type"
    CURRENT_VERSION="$target_version"
    
    print_success "Successfully switched to Fedora $target_version ($target_image_type)"
    exit 0
}

show_usage() {
    echo "Usage: $0 <version> <image_type>"
    echo "Run with 'list', 'current', or 'help' for more information."
}

main() {
    detect_current_config
    
    if [[ $# -eq 0 ]]; then
        print_header
        list_versions
        echo "Run '$0 help' for usage information"
        exit 0
    fi
    
    case "$1" in
        help|--help|-h)
            print_header; show_usage; exit 0 ;;
        list|--list|-l)
            print_header; list_versions; exit 0 ;;
        current|--current|-c)
            echo "Current: Fedora $CURRENT_VERSION ($CURRENT_IMAGE_TYPE)"
            exit 0 ;;
        42|43|44|rawhide)
            if validate_version "$1"; then
                local target_version="$1"
                local target_image_type="${2:-$CURRENT_IMAGE_TYPE}"
                if [[ $# -ge 2 ]] && ! validate_image_type "$target_image_type"; then
                    print_error "Invalid image type: $target_image_type"
                    exit 1
                fi
                print_header
                switch_version "$target_version" "$target_image_type"
            else
                print_error "Invalid version: $1"
                list_versions
                exit 1
            fi
            ;;
        *)
            print_error "Unknown argument: $1"
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
