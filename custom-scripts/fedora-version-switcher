#!/usr/bin/env bash
set -euo pipefail

# Fedora Version Switcher for Bootc Images
# Allows switching between Fedora versions and base image types for building custom bootc images
# Based on official Fedora bootc documentation

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Look for Containerfile in project root (parent of custom-scripts)
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CONTAINERFILE="${PROJECT_ROOT}/Containerfile"
VERSION_FILE="${PROJECT_ROOT}/.fedora-version"

# Current supported Fedora versions (as of September 2025)
# Fedora 41: Released October 29, 2024 (supported until ~1 month after F43)
# Fedora 42: Released April 15, 2025 (current stable)
# Fedora 43: Beta available, final release October 28, 2025
# Rawhide: Rolling development (always available)
SUPPORTED_VERSIONS=("41" "42" "43" "rawhide")
CURRENT_VERSION=""
CURRENT_IMAGE_TYPE=""

# Available base image types from official Fedora bootc project
# See: https://docs.fedoraproject.org/en-US/bootc/base-images/
declare -A IMAGE_TYPES=(
    ["fedora-bootc"]="quay.io/fedora/fedora-bootc"
    ["fedora-sway-atomic"]="quay.io/fedora/fedora-sway-atomic"
)

declare -A IMAGE_DESCRIPTIONS=(
    ["fedora-bootc"]="Minimal server base - requires desktop packages"
    ["fedora-sway-atomic"]="Full Sway desktop - pre-configured"
)

# Color codes for output (disabled in CI)
if [[ "${CI:-false}" == "true" ]]; then
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
fi

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║   Fedora Bootc Version Switcher       ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

detect_current_config() {
    # First, try to read from .fedora-version file
    if [[ -f "$VERSION_FILE" ]]; then
        if [[ -s "$VERSION_FILE" ]]; then
            CURRENT_VERSION=$(cat "$VERSION_FILE" | cut -d: -f1)
            CURRENT_IMAGE_TYPE=$(cat "$VERSION_FILE" | cut -d: -f2)
            
            # Validate the values
            if [[ -n "$CURRENT_VERSION" ]] && [[ -n "$CURRENT_IMAGE_TYPE" ]]; then
                return 0
            fi
        fi
    fi
    
    # Fallback: try to detect from Containerfile
    if [[ ! -f "$CONTAINERFILE" ]]; then
        print_error "Neither .fedora-version nor Containerfile found"
        exit 1
    fi
    
    # Try to parse ARG directives from Containerfile
    local version_arg=$(grep "^ARG FEDORA_VERSION=" "$CONTAINERFILE" | cut -d= -f2)
    local type_arg=$(grep "^ARG IMAGE_TYPE=" "$CONTAINERFILE" | cut -d= -f2)
    
    if [[ -n "$version_arg" ]] && [[ -n "$type_arg" ]]; then
        CURRENT_VERSION="$version_arg"
        CURRENT_IMAGE_TYPE="$type_arg"
        print_warning "No .fedora-version file found, using defaults from Containerfile"
        print_warning "Creating .fedora-version file..."
        save_version "$CURRENT_VERSION" "$CURRENT_IMAGE_TYPE"
    else
        print_error "Could not detect configuration from .fedora-version or Containerfile"
        CURRENT_VERSION="unknown"
        CURRENT_IMAGE_TYPE="unknown"
    fi
}

save_version() {
    echo "$1:$CURRENT_IMAGE_TYPE" > "$VERSION_FILE"
}

list_versions() {
    echo "Currently using: ${GREEN}Fedora $CURRENT_VERSION${NC} (${CURRENT_IMAGE_TYPE})"
    echo "  ${YELLOW}▸${NC} ${IMAGE_DESCRIPTIONS[$CURRENT_IMAGE_TYPE]:-Unknown image type}"
    echo
    echo "═══════════════════════════════════════════════════════════"
    echo "Available Fedora Versions:"
    echo "═══════════════════════════════════════════════════════════"
    echo
    echo "  ${BLUE}41${NC}  Fedora 41 (Released Oct 2024)"
    echo "      └─ Supported until ~1 month after F43 release"
    echo
    echo "  ${BLUE}42${NC}  Fedora 42 (Released Apr 2025) ${GREEN}← Current Stable${NC}"
    echo "      └─ ~13 months of support (until ~May 2026)"
    echo
    echo "  ${BLUE}43${NC}  Fedora 43 Beta (Final release Oct 28, 2025)"
    echo "      └─ Beta available for testing, GA coming soon"
    echo
    echo "  ${BLUE}rawhide${NC}  Rawhide (Rolling development)"
    echo "      └─ Bleeding edge, for development only"
    echo
    echo "═══════════════════════════════════════════════════════════"
    echo "Available Base Image Types:"
    echo "═══════════════════════════════════════════════════════════"
    echo
    echo "  ${BLUE}fedora-bootc${NC} - Minimal Server Base"
    echo "      ${YELLOW}Requires:${NC} Desktop packages installed via packages.desktop"
    echo "      ${YELLOW}Enables:${NC}  graphical.target, greetd, libvirtd,"
    echo "               systemd-resolved, NetworkManager"
    echo "      ${GREEN}Use case:${NC} Full control over desktop environment"
    echo "      Source: quay.io/fedora/fedora-bootc"
    echo
    echo "  ${BLUE}fedora-sway-atomic${NC} - Full Sway Desktop"
    echo "      ${GREEN}Includes:${NC} Pre-configured Sway desktop environment"
    echo "      ${YELLOW}Skips:${NC}    packages.desktop (already has desktop)"
    echo "      ${YELLOW}Skips:${NC}    Service enablement (pre-configured)"
    echo "      ${GREEN}Use case:${NC} Ready-to-use Sway desktop"
    echo "      Source: quay.io/fedora/fedora-sway-atomic"
    echo
    echo "═══════════════════════════════════════════════════════════"
    echo
}

validate_version() {
    local version=$1
    for v in "${SUPPORTED_VERSIONS[@]}"; do
        if [[ "$v" == "$version" ]]; then
            return 0
        fi
    done
    return 1
}

validate_image_type() {
    local type=$1
    if [[ -n "${IMAGE_TYPES[$type]:-}" ]]; then
        return 0
    fi
    return 1
}

backup_containerfile() {
    local backup_file
    backup_file="${CONTAINERFILE}.bak.$(date +%Y%m%d_%H%M%S)"
    cp "$CONTAINERFILE" "$backup_file"
    print_info "Backup created: $backup_file"
}

switch_version() {
    local target_version=$1
    local target_image_type="${2:-$CURRENT_IMAGE_TYPE}"
    
    if [[ "$target_version" == "$CURRENT_VERSION" ]] && [[ "$target_image_type" == "$CURRENT_IMAGE_TYPE" ]]; then
        print_warning "Already using Fedora $target_version ($target_image_type)"
        return 0
    fi
    
    print_info "Switching configuration:"
    echo "  From: Fedora $CURRENT_VERSION ($CURRENT_IMAGE_TYPE)"
    echo "  To:   Fedora $target_version ($target_image_type)"
    
    # Show what will happen based on image type
    if [[ "$target_image_type" == "fedora-bootc" ]]; then
        echo
        print_warning "Switching to fedora-bootc will:"
        echo "  • Install desktop packages from packages.desktop"
        echo "  • Enable graphical.target, greetd, libvirtd"
        echo "  • Enable systemd-resolved, NetworkManager"
        echo "  • Use FROM quay.io/fedora/fedora-bootc:$target_version"
    elif [[ "$target_image_type" == "fedora-sway-atomic" ]]; then
        echo
        print_info "Switching to fedora-sway-atomic will:"
        echo "  • Skip packages.desktop (desktop pre-installed)"
        echo "  • Skip service enablement (pre-configured)"
        echo "  • Use FROM quay.io/fedora/fedora-sway-atomic:$target_version"
    fi
    
    echo
    
    # Create backup (skip in CI to avoid cluttering the workspace)
    if [[ "${CI:-false}" != "true" ]]; then
        backup_containerfile
    fi
    
    # Update the .fedora-version file (this is what Makefile and CI use)
    save_version "$target_version" "$target_image_type"
    
    # Update current image type
    CURRENT_IMAGE_TYPE="$target_image_type"
    CURRENT_VERSION="$target_version"
    
    print_success "Successfully switched to Fedora $target_version ($target_image_type)"
    
    # Show the configuration
    echo
    print_info "Configuration saved to .fedora-version:"
    cat "$VERSION_FILE" | sed 's/^/  /'
    
    echo
    print_info "Build arguments will be:"
    echo "  FEDORA_VERSION=$target_version"
    echo "  IMAGE_TYPE=$target_image_type"
    
    echo
    print_info "This will result in:"
    echo "  FROM quay.io/fedora/${target_image_type}:${target_version}"
    
    return 0
}

save_version() {
    local version=$1
    local image_type=$2
    echo "${version}:${image_type}" > "$VERSION_FILE"
}
        print_warning "Already using Fedora $target_version ($target_image_type)"
        return 0
    fi
    
    print_info "Switching configuration:"
    echo "  From: Fedora $CURRENT_VERSION ($CURRENT_IMAGE_TYPE)"
    echo "  To:   Fedora $target_version ($target_image_type)"
    
    # Show what will happen based on image type
    if [[ "$target_image_type" == "fedora-bootc" ]]; then
        echo
        print_warning "Switching to fedora-bootc will:"
        echo "  • Install desktop packages from packages.desktop"
        echo "  • Enable graphical.target, greetd, libvirtd"
        echo "  • Enable systemd-resolved, NetworkManager"
    elif [[ "$target_image_type" == "fedora-sway-atomic" ]]; then
        echo
        print_info "Switching to fedora-sway-atomic will:"
        echo "  • Skip packages.desktop (desktop pre-installed)"
        echo "  • Skip service enablement (pre-configured)"
    fi
    
    echo
    
    # Create backup (skip in CI to avoid cluttering the workspace)
    if [[ "${CI:-false}" != "true" ]]; then
        backup_containerfile
    fi
    
    # Get the target image base URL
    local target_image
    target_image="${IMAGE_TYPES[$target_image_type]}"
    
    # Update the FROM line in Containerfile
    # Match both fedora-sway-atomic and fedora-bootc patterns
    sed -i "s|FROM quay.io/fedora/fedora-\(sway-atomic\|bootc\):[0-9]\+\|FROM quay.io/fedora/fedora-\(sway-atomic\|bootc\):rawhide|FROM ${target_image}:${target_version}|g" "$CONTAINERFILE"
    
    # Update current image type
    CURRENT_IMAGE_TYPE="$target_image_type"
    
    # Save the version to file
    save_version "$target_version"
    
    print_success "Successfully switched to Fedora $target_version ($target_image_type)"
    
    # Show the updated FROM line
    echo
    print_info "Updated Containerfile FROM line:"
    grep "^FROM" "$CONTAINERFILE" | sed 's/^/  /'
    
    return 0
}

show_usage() {
    cat << EOF
Usage: $0 [VERSION] [IMAGE_TYPE]

Switch the Fedora version and/or base image type in the Containerfile for
building custom bootable container images.

═══════════════════════════════════════════════════════════════════════
VERSIONS:
═══════════════════════════════════════════════════════════════════════
    41          Fedora 41 (Oct 2024 - ~Nov 2025)
    42          Fedora 42 (Current stable, Apr 2025 - ~May 2026)
    43          Fedora 43 Beta (Final release Oct 28, 2025)
    rawhide     Rawhide (Rolling development, bleeding edge)

═══════════════════════════════════════════════════════════════════════
IMAGE TYPES (optional):
═══════════════════════════════════════════════════════════════════════
    fedora-bootc         Minimal server base (adds desktop via Containerfile)
                         • Installs packages.desktop for Sway environment
                         • Enables: graphical.target, greetd, libvirtd,
                           systemd-resolved, NetworkManager
                         • Use when you want full control over the desktop
                         
    fedora-sway-atomic   Full Sway desktop (desktop pre-configured)
                         • Skips packages.desktop (already included)
                         • Skips service enablement (pre-configured)
                         • Use for ready-to-use Sway experience

═══════════════════════════════════════════════════════════════════════
COMMANDS:
═══════════════════════════════════════════════════════════════════════
    list           List all available versions and image types
    current        Show current version and image type
    help           Show this help message

═══════════════════════════════════════════════════════════════════════
EXAMPLES:
═══════════════════════════════════════════════════════════════════════
    $0 42
        Switch to Fedora 42 (keeps current image type)
        
    $0 43 fedora-bootc
        Switch to Fedora 43 with bootc base (installs desktop)
        
    $0 42 fedora-sway-atomic
        Switch to Fedora 42 with pre-configured Sway desktop
        
    $0 rawhide
        Switch to Rawhide rolling release
        
    $0 list
        List available versions with detailed information
        
    $0 current
        Show current configuration

═══════════════════════════════════════════════════════════════════════
PACKAGE BEHAVIOR:
═══════════════════════════════════════════════════════════════════════
    packages.add      - Always installed (both image types)
    packages.remove   - Always removed (both image types)
    packages.desktop  - Only installed with fedora-bootc base
                        (skipped for fedora-sway-atomic)

═══════════════════════════════════════════════════════════════════════
NOTES:
═══════════════════════════════════════════════════════════════════════
    • Fedora provides approximately 13 months of support per release
    • The N-2 release reaches EOL 4 weeks after N is released
    • Upgrades across more than 2 releases are not supported
    • Rawhide is for development/testing only, not production use
    • Base images are built from official Fedora bootc project
    
    Documentation: https://docs.fedoraproject.org/en-US/bootc/

EOF
}

main() {
    detect_current_config
    
    if [[ $# -eq 0 ]]; then
        print_header
        list_versions
        echo "Run '$0 help' for usage information"
        exit 0
    fi
    
    case "$1" in
        help|--help|-h)
            print_header
            show_usage
            exit 0
            ;;
        list|--list|-l)
            print_header
            list_versions
            exit 0
            ;;
        current|--current|-c)
            echo "Current: Fedora $CURRENT_VERSION ($CURRENT_IMAGE_TYPE)"
            echo "  ${IMAGE_DESCRIPTIONS[$CURRENT_IMAGE_TYPE]:-Unknown image type}"
            exit 0
            ;;
        41|42|43|rawhide)
            if validate_version "$1"; then
                local target_version
                local target_image_type
                
                target_version="$1"
                target_image_type="${2:-$CURRENT_IMAGE_TYPE}"
                
                # Validate image type if provided
                if [[ $# -ge 2 ]] && ! validate_image_type "$target_image_type"; then
                    print_error "Invalid image type: $target_image_type"
                    echo
                    echo "Valid image types: fedora-bootc, fedora-sway-atomic"
                    exit 1
                fi
                
                print_header
                switch_version "$target_version" "$target_image_type"
                
                if [[ "${CI:-false}" != "true" ]]; then
                    echo
                    print_info "Next steps:"
                    echo "  1. Review changes:    cat .fedora-version"
                    echo "  2. Build the image:   make build"
                    echo "  3. Test locally:      podman run --rm <image> cat /etc/os-release"
                    echo "  4. Commit changes:    git add .fedora-version"
                    echo "                        git commit -m 'Switch to Fedora $target_version ($target_image_type)'"
                fi
                exit 0
            else
                print_error "Invalid version: $1"
                echo
                list_versions
                exit 1
            fi
            ;;
        *)
            print_error "Unknown argument: $1"
            echo
            show_usage
            exit 1
            ;;
    esac
}

main "$@"