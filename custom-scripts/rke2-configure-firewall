#!/usr/bin/env bash
set -euo pipefail

# Configure required firewall ports for RKE2 servers.
# Prefers firewall-offline-cmd for build-time configuration and falls back to
# firewall-cmd when available. Emits a warning and exits successfully when no
# firewalld utilities are present to avoid failing image builds.

open_ports_offline() {
  firewall-offline-cmd --add-port=6443/tcp      # Kubernetes API server
  firewall-offline-cmd --add-port=9345/tcp      # RKE2 supervisor API (agent registration)
  firewall-offline-cmd --add-port=10250/tcp     # Kubelet metrics
  firewall-offline-cmd --add-port=2379-2380/tcp # etcd client/peer communication
}

open_ports_runtime() {
  firewall-cmd --permanent --add-port=6443/tcp      # Kubernetes API server
  firewall-cmd --permanent --add-port=9345/tcp      # RKE2 supervisor API (agent registration)
  firewall-cmd --permanent --add-port=10250/tcp     # Kubelet metrics
  firewall-cmd --permanent --add-port=2379-2380/tcp # etcd client/peer communication
}

main() {
  if command -v firewall-offline-cmd >/dev/null 2>&1; then
    open_ports_offline
  elif command -v firewall-cmd >/dev/null 2>&1; then
    open_ports_runtime
  else
    echo "⚠️ firewalld utilities not available; skipping RKE2 firewall configuration" >&2
  fi
}

main "$@"
