#!/usr/bin/env bash
set -euo pipefail

PROFILE="custom/with-u2f"

# Create a new authselect profile based on the current system-auth
if ! authselect list | grep -q "$PROFILE"; then
    echo "[*] Creating authselect profile: $PROFILE"
    authselect create-profile with-u2f \
        -b sssd \
        --symlink-meta
fi

# Apply it
echo "[*] Applying authselect profile"
authselect select $PROFILE --force

# Insert pam_u2f.so into system-auth
PAM_FILE="/etc/authselect/$PROFILE/system-auth"
if ! grep -q "pam_u2f.so" "$PAM_FILE"; then
    echo "[*] Enabling U2F in $PAM_FILE"
    # Insert after pam_unix.so line in auth stack
    sed -i '/pam_unix.so/a auth    sufficient    pam_u2f.so cue origin=pam appid=pam' "$PAM_FILE"
fi

# Update authselect after modification
authselect apply-changes

echo "[+] U2F configuration applied."
