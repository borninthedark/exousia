#!/usr/bin/env python3
"""
Dynamic README Generator for Exousia Bootc Images

Generates comprehensive documentation with:
- Automatic Table of Contents
- Collapsible sections for verbose content
- Current build configuration from adnyeus.yml
"""

import argparse
import os
import re
import subprocess
import sys
from datetime import datetime, timezone
from pathlib import Path
from typing import Optional
from urllib.parse import quote

try:
    import yaml
except ImportError:
    yaml = None


class Colors:
    """Terminal colors (disabled in CI)."""
    def __init__(self):
        if os.environ.get('CI') == 'true':
            self.GREEN = self.BLUE = self.YELLOW = self.RED = self.NC = ''
        else:
            self.GREEN = '\033[0;32m'
            self.BLUE = '\033[0;34m'
            self.YELLOW = '\033[1;33m'
            self.RED = '\033[0;31m'
            self.NC = '\033[0m'

    def success(self, msg: str) -> None:
        print(f"{self.GREEN}âœ“{self.NC} {msg}")

    def info(self, msg: str) -> None:
        print(f"{self.BLUE}â„¹{self.NC} {msg}")

    def warning(self, msg: str) -> None:
        print(f"{self.YELLOW}âš {self.NC} {msg}")

    def error(self, msg: str) -> None:
        print(f"{self.RED}âœ—{self.NC} {msg}", file=sys.stderr)


class Config:
    """Build configuration extracted from repository."""
    def __init__(self):
        self.os_name = "Linux"
        self.os_logo = "linux"
        self.os_badge_color = "0A74DA"
        self.os_version = ""
        self.image_type = ""
        self.image_type_display = ""
        self.wm_de_label = "Unknown"
        self.github_repo = ""
        self.github_owner = ""
        self.ghcr_image = ""
        self.docker_image = ""
        self.build_date = ""
        self.build_badge_text_uri = ""


def get_repo_root() -> Path:
    """Determine repository root reliably."""
    if github_ws := os.environ.get('GITHUB_WORKSPACE'):
        return Path(github_ws)

    script_path = Path(__file__).resolve()
    return script_path.parent.parent


def extract_config(repo_root: Path, colors: Colors) -> Config:
    """Extract configuration from repository metadata."""
    config = Config()
    colors.info(f"Repository root: {repo_root}")

    adnyeus_path = repo_root / "adnyeus.yml"
    base_image = ""

    # Parse adnyeus.yml
    if adnyeus_path.exists():
        colors.info(f"Found image definition blueprint: {adnyeus_path}")

        if yaml:
            with open(adnyeus_path) as f:
                blueprint = yaml.safe_load(f)
            base_image = blueprint.get('base-image', '')
            config.os_version = str(blueprint.get('image-version', ''))

            # Get desktop/window manager
            desktop = blueprint.get('desktop', {})
            de = desktop.get('desktop_environment', '')
            wm = desktop.get('window_manager', '')

            if de:
                de_labels = {
                    'lxqt': 'LXQt', 'kde': 'KDE Plasma', 'mate': 'MATE', 'gnome': 'GNOME'
                }
                config.wm_de_label = de_labels.get(de.lower(), de.capitalize())
            elif wm:
                config.wm_de_label = wm.capitalize()
        else:
            # Fallback to regex parsing if PyYAML not available
            content = adnyeus_path.read_text()
            if match := re.search(r'^base-image:\s*(.+)$', content, re.MULTILINE):
                base_image = match.group(1).strip().strip('"\'')
            if match := re.search(r'^image-version:\s*(.+)$', content, re.MULTILINE):
                config.os_version = match.group(1).strip().strip('"\'')
            if match := re.search(r'window_manager:\s*(.+)$', content, re.MULTILINE):
                config.wm_de_label = match.group(1).strip().strip('"\'').capitalize()
    else:
        colors.warning("adnyeus.yml not found; relying on pipeline inputs")

    # Detect OS from base image
    if base_image:
        base_lower = base_image.lower()
        os_map = {
            'fedora': ('Fedora', 'fedora', '0A74DA'),
            'ubuntu': ('Ubuntu', 'ubuntu', 'E95420'),
            'debian': ('Debian', 'debian', 'A81D33'),
            'arch': ('Arch Linux', 'arch-linux', '1793D1'),
            'rocky': ('Rocky Linux', 'rockylinux', '10B981'),
            'almalinux': ('AlmaLinux', 'almalinux', '0A76B8'),
        }
        for key, (name, logo, color) in os_map.items():
            if key in base_lower:
                config.os_name, config.os_logo, config.os_badge_color = name, logo, color
                break

        # Extract version from base image tag if not set
        if not config.os_version and ':' in base_image:
            config.os_version = base_image.rsplit(':', 1)[1].split('@')[0]

    # Check .fedora-version file (takes precedence)
    version_file = repo_root / ".fedora-version"
    if version_file.exists() and version_file.stat().st_size > 0:
        version_info = version_file.read_text().strip()
        parts = version_info.split(':')
        config.os_version = parts[0]
        if len(parts) > 1:
            config.image_type = parts[1]

    # Set display name
    type_displays = {
        'fedora-sway-atomic': 'Fedora Sway Atomic Desktop',
        'fedora-bootc': 'Fedora bootc Base',
    }
    config.image_type_display = type_displays.get(config.image_type, config.image_type or 'Unknown')

    if not config.os_version:
        config.os_version = "unknown"

    if config.os_version:
        colors.info(f"Blueprint version detected: {config.os_name} {config.os_version}")

    # Get GitHub repository
    if github_repo := os.environ.get('GITHUB_REPOSITORY'):
        config.github_repo = github_repo
    else:
        try:
            result = subprocess.run(
                ['git', '-C', str(repo_root), 'remote', 'get-url', 'origin'],
                capture_output=True, text=True, check=True
            )
            url = result.stdout.strip()
            # Extract owner/repo from various URL formats
            match = re.search(r'[:/]([^/]+/[^/]+?)(?:\.git)?$', url)
            if match:
                config.github_repo = match.group(1).replace('.git', '')
                # Clean up proxy paths
                if '/git/' in config.github_repo:
                    config.github_repo = config.github_repo.split('/git/')[-1]
                colors.info(f"Detected GitHub repository: {config.github_repo}")
        except (subprocess.CalledProcessError, FileNotFoundError):
            colors.warning("Could not detect GitHub repository, using default")
            config.github_repo = "borninthedark/exousia"

    config.github_owner = config.github_repo.split('/')[0]
    config.ghcr_image = f"ghcr.io/{config.github_owner}/exousia"
    config.docker_image = f"docker.io/{config.github_owner}/exousia"
    config.build_date = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

    badge_text = f"{config.os_name} {config.os_version} â€¢ {config.wm_de_label}"
    config.build_badge_text_uri = quote(badge_text)

    return config


def generate_toc(sections: list[tuple[str, str, int]]) -> str:
    """Generate Table of Contents from sections.

    Args:
        sections: List of (title, anchor, level) tuples
    """
    lines = ["## Table of Contents", ""]
    for title, anchor, level in sections:
        indent = "  " * (level - 2)
        lines.append(f"{indent}- [{title}](#{anchor})")
    return "\n".join(lines)


def slugify(title: str) -> str:
    """Convert title to GitHub anchor slug."""
    slug = title.lower()
    slug = re.sub(r'[^\w\s-]', '', slug)
    slug = re.sub(r'\s+', '-', slug)
    return slug


def collapsible(summary: str, content: str) -> str:
    """Wrap content in a collapsible details block."""
    return f"""<details>
<summary>{summary}</summary>

{content}
</details>"""


def generate_readme(config: Config) -> str:
    """Generate the complete README content."""

    # Define all sections for ToC
    sections = [
        ("Highly Experimental Disclaimer", "highly-experimental-disclaimer", 2),
        ("Project Snapshot", "project-snapshot", 2),
        ("Build & Release Workflow", "build--release-workflow", 2),
        ("Getting Started", "getting-started", 2),
        ("Triggering Builds Remotely", "triggering-builds-remotely", 2),
        ("Customizing Builds", "customizing-builds", 2),
        ("Package Validation & Dependency Tooling", "package-validation--dependency-tooling", 2),
        ("Required Secrets", "required-secrets", 2),
        ("Documentation", "documentation", 2),
        ("External Resources", "external-resources", 2),
        ("Contributing", "contributing", 2),
        ("License", "license", 2),
        ("Acknowledgments", "acknowledgments", 2),
    ]

    toc = generate_toc(sections)

    # Python webhook examples
    python_examples = '''```bash
# Set your GitHub token
export GITHUB_TOKEN="ghp_your_token_here"

# Trigger a build using repo defaults
python api/webhook_trigger.py

# Trigger specific image type and version
python api/webhook_trigger.py \\
  --image-type fedora-sway-atomic \\
  --distro-version 43 \\
  --enable-plymouth

# Build with specific window manager
python api/webhook_trigger.py --wm sway --distro-version 43

# Build with specific desktop environment
python api/webhook_trigger.py --de kde --distro-version 44
```'''

    python_advanced = '''```bash
# Use a YAML definition file
python api/webhook_trigger.py --yaml sway-bootc.yml --distro-version 44

# Build with combined DE+WM (e.g., LXQt with Sway)
python api/webhook_trigger.py --de lxqt --wm sway --distro-version 43

# Build with Debian
python api/webhook_trigger.py --os debian --image-type debian-bootc --wm sway --distro-version 12

# Disable Plymouth
python api/webhook_trigger.py --yaml sway-atomic.yml --disable-plymouth --verbose
```'''

    # cURL example (just one representative example, rest in collapsible)
    curl_basic = f'''```bash
curl -X POST \\
  -H "Accept: application/vnd.github+json" \\
  -H "Authorization: Bearer $GITHUB_TOKEN" \\
  -H "X-GitHub-Api-Version: 2022-11-28" \\
  https://api.github.com/repos/{config.github_repo}/dispatches \\
  -d '{{
    "event_type": "api",
    "client_payload": {{
      "image_type": "fedora-bootc",
      "distro_version": "44",
      "enable_plymouth": true
    }}
  }}'
```'''

    curl_advanced = f'''```bash
# With specific YAML definition
curl -X POST -H "Accept: application/vnd.github+json" \\
  -H "Authorization: Bearer $GITHUB_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" \\
  https://api.github.com/repos/{config.github_repo}/dispatches \\
  -d '{{"event_type": "api", "client_payload": {{"image_type": "fedora-bootc", "distro_version": "44", "yaml_config": "sway-bootc.yml"}}}}'

# With window manager
curl -X POST -H "Accept: application/vnd.github+json" \\
  -H "Authorization: Bearer $GITHUB_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" \\
  https://api.github.com/repos/{config.github_repo}/dispatches \\
  -d '{{"event_type": "api", "client_payload": {{"image_type": "fedora-bootc", "distro_version": "43", "window_manager": "sway"}}}}'

# With desktop environment
curl -X POST -H "Accept: application/vnd.github+json" \\
  -H "Authorization: Bearer $GITHUB_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" \\
  https://api.github.com/repos/{config.github_repo}/dispatches \\
  -d '{{"event_type": "api", "client_payload": {{"image_type": "fedora-bootc", "distro_version": "44", "desktop_environment": "kde"}}}}'
```'''

    # Package validation examples
    pkg_validation_examples = '''```bash
# Fedora
python3 tools/package_dependency_checker.py --packages python3-requests neovim

# Arch Linux
python3 tools/package_dependency_checker.py --distro arch --packages python-requests hyprland

# Debian/Ubuntu
python3 tools/package_dependency_checker.py --distro debian --packages python3-requests sway

# OpenSUSE
python3 tools/package_dependency_checker.py --distro opensuse --packages python3-requests waybar

# Gentoo
python3 tools/package_dependency_checker.py --distro gentoo --packages dev-python/requests greetd

# FreeBSD
python3 tools/package_dependency_checker.py --distro freebsd --packages py311-requests sway
```'''

    # Pre-generate all collapsible sections
    python_advanced_section = collapsible("More Python examples", python_advanced)
    curl_advanced_section = collapsible("More cURL examples", curl_advanced)
    pkg_validation_section = collapsible("Distro-specific examples", pkg_validation_examples)
    hyprland_copr_section = collapsible("Hyprland COPR setup", """Enable required COPRs before building Hyprland:

```bash
sudo dnf copr enable lionheartp/Hyprland
sudo dnf copr enable erikreider/SwayNotificationCenter  # for SwayNC
sudo dnf copr enable tofik/nwg-shell  # for nwg-displays
sudo dnf update --refresh
```

Note: `wallust` requires Hyprland COPR; `nwg-displays` requires nwg-shell COPR.""")

    readme = f'''# Exousia: Declarative Bootc Builder

[![Reiatsu](https://img.shields.io/github/actions/workflow/status/{config.github_repo}/build.yml?branch=main&style=for-the-badge&logo=zap&logoColor=white&label=Reiatsu&color=00A4EF)](https://github.com/{config.github_repo}/actions/workflows/build.yml)
[![Last Build: {config.os_name} {config.os_version} â€¢ {config.wm_de_label}](https://img.shields.io/badge/Last%20Build-{config.build_badge_text_uri}-{config.os_badge_color}?style=for-the-badge&logo={config.os_logo}&logoColor=white)](https://github.com/{config.github_repo}/actions/workflows/build.yml?query=branch%3Amain+is%3Asuccess)
[![Code Quality](https://img.shields.io/github/actions/workflow/status/{config.github_repo}/build.yml?branch=main&style=for-the-badge&logo=githubactions&logoColor=white&label=Code%20Quality)](https://github.com/{config.github_repo}/actions/workflows/build.yml)
[![Highly Experimental](https://img.shields.io/badge/Highly%20Experimental-DANGER%21-E53935?style=for-the-badge&logo=skull&logoColor=white)](#highly-experimental-disclaimer)
<img src=".github/blue-sparrow.svg" alt="Blue Sparrow" width="28" />

Build custom, container-based immutable operating systems using the [**bootc project**](https://github.com/bootc-dev/bootc). Images are built, tested, scanned, and published via GitHub Actions.

**Note:** The "Reiatsu" badge is inspired by *BLEACH* by **Tite Kubo** â€” used as a playful status indicator with full acknowledgment.

Exousia builds custom, container-based immutable operating systems using [bootc](https://github.com/bootc-dev/bootc) and GitHub Actions. It focuses on reproducible, security-conscious laptop images with fast iteration cycles.

{toc}

---

## Highly Experimental Disclaimer

> **Warning**: This project is highly experimental. There are **no guarantees** about stability, data safety, or fitness for any purpose. Proceed only if you understand the risks.

---

## Project Snapshot

- **Purpose:** Declarative laptop images with a DevSecOps-friendly workflow.
- **Outputs:** bootc base images and atomic desktops (e.g., Sway, KDE) published to GHCR and Docker Hub.
- **Tooling:** FastAPI webhook entrypoint, Python helpers in `tools/`, and YAML-based blueprints.
- **Security/Quality:** Linting, scanning, signing, and automated tests baked into CI.

---

## Build & Release Workflow

**Triggers:** pushes to `main`, pull requests, nightly schedule (`10 3 * * *` UTC), manual dispatch, and `repository_dispatch` events.

| Stage | What happens |
|-------|--------------|
| **Build** | Hadolint linting, dynamic tagging, Buildah image build |
| **Test** | Bats integration tests, ShellCheck, `bootc container lint` |
| **Scan** | Trivy vulnerability scan, Semgrep static analysis |
| **Push & Sign** | Push to GHCR/Docker Hub and sign with Cosign |

---

## Getting Started

### Prerequisites

- Fedora system (Atomic variant recommended)
- Access to Docker Hub or GHCR
- Basic familiarity with bootc/container workflows

### Use a Published Image

```bash
# From Docker Hub (recommended)
sudo bootc switch docker.io/{config.github_owner}/exousia:latest
sudo bootc upgrade && sudo systemctl reboot

# From GHCR
sudo bootc switch ghcr.io/{config.github_owner}/exousia:latest
sudo bootc upgrade && sudo systemctl reboot
```

### Build Locally

```bash
git clone https://github.com/{config.github_repo}.git
cd exousia
make build
```

---

## Triggering Builds Remotely

Trigger builds programmatically via the webhook API.

**Prerequisites:** GitHub PAT with `repo` scope, Python 3.7+ with `requests`

### Python CLI

{python_examples}

{python_advanced_section}

### cURL API

{curl_basic}

{curl_advanced_section}

View builds: **https://github.com/{config.github_repo}/actions** | ðŸ“š [Webhook API Guide](docs/WEBHOOK_API.md)

---

## Customizing Builds

### Switch Blueprint Versions

```bash
# Via webhook API
python api/webhook_trigger.py --image-type fedora-bootc --distro-version 44
python api/webhook_trigger.py --image-type fedora-sway-atomic --distro-version 43
```

Or use **Actions â†’ Fedora Bootc DevSec CI â†’ Run workflow** in the GitHub UI.

### Adjust Packages

| Image Type | Where to edit | What to change |
|------------|---------------|----------------|
| bootc | `packages/window-managers/*.yml` | Add to `utilities:` list |
| atomic | `yaml-definitions/*.yml` | Add to `install:` list |

{hyprland_copr_section}

### Configuration Files

| Directory | Purpose |
|-----------|---------|
| `custom-configs/sway/` | Sway WM and config.d snippets |
| `custom-configs/waybar/` | Waybar status bar |
| `custom-configs/greetd/` | Display manager (bootc) |
| `custom-configs/plymouth/` | Boot splash themes |
| `custom-configs/rancher/rke2/` | RKE2 Kubernetes config |
| `custom-scripts/` | Scripts copied to `/usr/local/bin/` |

### Desktop & Boot Experience

- **Sway** uses `sway-config-minimal` for headless/container compatibility.
  - `/usr/share/sway/config.d/*.conf` â€” Packaged configs
  - `/etc/sway/config.d/*.conf` â€” System overrides
  - `~/.config/sway/config.d/*.conf` â€” User overrides
  - See [Fedora Sericea Configuration Guide](https://docs.fedoraproject.org/en-US/fedora-sericea/configuration-guide/).
- **Plymouth**: Set `enable_plymouth: true` in YAML; themes live in `custom-configs/plymouth/themes/`.
- **Display managers**: bootc images use greetd; atomic images use SDDM.

---

## Package Validation & Dependency Tooling

### Package Dependency Checker

Cross-distro package dependency translation and verification.

```bash
python3 tools/package_dependency_checker.py --packages python3-requests neovim
python3 tools/package_dependency_checker.py --verify-only --json
```

{pkg_validation_section}

### Validation CLI

```bash
python3 tools/validate_installed_packages.py --yaml adnyeus.yml --image-type fedora-bootc
python3 tools/validate_installed_packages.py --wm hyprland --distro arch
```

**Package naming equivalents:**

| Distro | Example |
|--------|---------|
| Fedora/Debian | `python3-requests` |
| Arch | `python-requests` |
| Gentoo | `dev-python/requests` |
| FreeBSD | `py311-requests` |

---

## Required Secrets

Configure in **Settings â†’ Secrets and variables â†’ Actions**:

| Secret | Purpose |
|--------|---------|
| `GHCR_PAT` | GHCR with `write:packages` scope |
| `DOCKERHUB_USERNAME` | Docker Hub username |
| `DOCKERHUB_TOKEN` | Docker Hub access token |
| `CODECOV_TOKEN` | Code coverage from [codecov.io](https://codecov.io) |

---

## Documentation

### Getting Started
- [BOOTC_UPGRADE.md](docs/BOOTC_UPGRADE.md) â€” Upgrade and switch images
- [BOOTC_IMAGE_BUILDER.md](docs/BOOTC_IMAGE_BUILDER.md) â€” Build disk images

### API
- [API Overview](docs/api/README.md) | [Endpoints](docs/api/endpoints.md) | [Development](docs/api/development.md)

### Testing
- [Testing Guide](docs/testing/guide.md) | [Test Suite](docs/testing/test_suite.md) | [Writing Tests](docs/reference/writing-tests.md)

### Reference
- [Plymouth Usage](docs/reference/plymouth_usage_doc.md) | [Troubleshooting](docs/reference/troubleshooting.md)

---

## External Resources

**Official:** [bootc Project](https://github.com/bootc-dev/bootc) | [bootc Docs](https://bootc-dev.github.io/bootc/) | [Fedora bootc](https://docs.fedoraproject.org/en-US/bootc/)

**Community:** [Fedora Discussion](https://discussion.fedoraproject.org/tag/bootc) | [BlueBuild](https://blue-build.org/) | [Universal Blue](https://universal-blue.org/)

---

## Contributing

Contributions welcome! Submit PRs or open issues.

---

## License

MIT License â€” see LICENSE file.

---

## Acknowledgments

- [bootc project](https://github.com/bootc-dev/bootc) maintainers and Fedora community
- [Fedora Sway SIG](https://gitlab.com/fedora/sigs/sway/sway-config-fedora) for Sway configs and QoL improvements
- [openSUSEway](https://github.com/openSUSE/openSUSEway) for Sway enhancements
- [Universal Blue](https://universal-blue.org/) and [BlueBuild](https://blue-build.org/) for container-native workflows
- [RKE2](https://docs.rke2.io/) / [Rancher by SUSE](https://www.rancher.com/) for Kubernetes
- [Buildah](https://buildah.io/), [Skopeo](https://github.com/containers/skopeo), [Podman](https://podman.io/)
- **Claude** (Anthropic) and **GPT Codex** (OpenAI) for AI-assisted development

### Creative Acknowledgments

**Tite Kubo** â€” Creator of *BLEACH*. The "Reiatsu" status indicator is inspired by themes from BLEACH, used respectfully as a playful aesthetic. All rights belong to Tite Kubo and respective copyright holders.

---

**Built with bootc**

*Generated on {config.build_date}*
'''

    return readme


def main():
    parser = argparse.ArgumentParser(
        description="Generate dynamic README.md with current build configuration"
    )
    parser.add_argument('--image-type', help="Override image type")
    parser.add_argument('--dry-run', action='store_true', help="Preview without writing")
    args = parser.parse_args()

    colors = Colors()
    repo_root = get_repo_root()
    readme_path = repo_root / "README.md"

    colors.info("Extracting configuration from repository metadata...")
    config = extract_config(repo_root, colors)

    if args.image_type:
        config.image_type = args.image_type
        colors.info(f"Using custom image type: {config.image_type}")

    colors.info("Configuration detected:")
    print(f"  - OS: {config.os_name} {config.os_version}")
    print(f"  - Image Type: {config.image_type_display}")
    print(f"  - GitHub Repo: {config.github_repo}")
    print(f"  - GHCR Image: {config.ghcr_image}")
    print(f"  - Docker Hub Image: {config.docker_image}")
    print()

    readme_content = generate_readme(config)

    if args.dry_run:
        colors.info("Dry run mode - displaying generated content:")
        print("â”€" * 50)
        print(readme_content)
        print("â”€" * 50)
        colors.warning("Dry run complete - README.md was not modified")
    else:
        colors.info("Generating README.md...")
        readme_path.write_text(readme_content)
        colors.success(f"README.md generated successfully at: {readme_path}")

        if os.environ.get('CI') != 'true':
            print()
            colors.info("Next steps:")
            print("  1. Review the generated README: less README.md")
            print("  2. Commit the changes: git add README.md && git commit")


if __name__ == "__main__":
    main()
