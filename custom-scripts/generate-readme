#!/usr/bin/env bash
set -euo pipefail

# Dynamic README Generator for Fedora Bootc Images
# Generates comprehensive documentation with current build configuration

# Determine repository root more reliably
if [[ -n "${GITHUB_WORKSPACE:-}" ]]; then
    # Use GITHUB_WORKSPACE in CI environment
    REPO_ROOT="$GITHUB_WORKSPACE"
elif [[ -n "${BASH_SOURCE[0]:-}" ]]; then
    # Use BASH_SOURCE for local execution
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
else
    # Fallback to current directory
    REPO_ROOT="$(pwd)"
fi

README_FILE="${REPO_ROOT}/README.md"
FEDORA_VERSION_FILE="${REPO_ROOT}/.fedora-version"

# Determine which Containerfile to use based on .fedora-version file
determine_containerfile() {
    local image_type="${1:-}"
    
    # First, try to read from .fedora-version file (matches workflow behavior)
    if [[ -f "$FEDORA_VERSION_FILE" ]] && [[ -s "$FEDORA_VERSION_FILE" ]]; then
        local version_info
        version_info=$(cat "$FEDORA_VERSION_FILE")
        local detected_image_type
        detected_image_type=$(echo "$version_info" | cut -d: -f2)
        
        if [[ -n "$detected_image_type" ]]; then
            image_type="$detected_image_type"
            print_info "Detected image type from .fedora-version: $image_type"
        fi
    fi
    
    # Determine Containerfile path based on image type (matches workflow logic)
    if [[ "$image_type" == "fedora-bootc" ]]; then
        if [[ -f "${REPO_ROOT}/Containerfile.bootc" ]]; then
            echo "${REPO_ROOT}/Containerfile.bootc"
            return
        fi
    elif [[ "$image_type" == "fedora-sway-atomic" ]]; then
        if [[ -f "${REPO_ROOT}/Containerfile.atomic" ]]; then
            echo "${REPO_ROOT}/Containerfile.atomic"
            return
        fi
    fi
    
    # Try to detect from symlink
    if [[ -L "${REPO_ROOT}/Containerfile" ]]; then
        local target
        target=$(readlink "${REPO_ROOT}/Containerfile")
        if [[ "$target" == *"Containerfile.atomic"* ]]; then
            echo "${REPO_ROOT}/Containerfile.atomic"
            return
        elif [[ "$target" == *"Containerfile.bootc"* ]]; then
            echo "${REPO_ROOT}/Containerfile.bootc"
            return
        fi
    fi
    
    # Fallback: try to find any available Containerfile
    for file in "${REPO_ROOT}/Containerfile.atomic" "${REPO_ROOT}/Containerfile.bootc" "${REPO_ROOT}/Containerfile"; do
        if [[ -f "$file" ]]; then
            echo "$file"
            return
        fi
    done
    
    # Default fallback
    echo "${REPO_ROOT}/Containerfile"
}

CONTAINERFILE=$(determine_containerfile "${IMAGE_TYPE:-}")

# Color codes for output (disabled in CI)
if [[ "${CI:-false}" == "true" ]]; then
    GREEN='' BLUE='' YELLOW='' NC=''
else
    GREEN='\033[0;32m'
    BLUE='\033[0;34m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
fi

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "\033[0;31m✗${NC} $1" >&2
}

# Extract configuration from Containerfile
extract_config() {
    # Debug: Show paths being used
    print_info "Repository root: $REPO_ROOT"
    print_info "Looking for Containerfile at: $CONTAINERFILE"
    
    # Read current configuration from .fedora-version if available
    if [[ -f "$FEDORA_VERSION_FILE" ]] && [[ -s "$FEDORA_VERSION_FILE" ]]; then
        local version_info
        version_info=$(cat "$FEDORA_VERSION_FILE")
        FEDORA_VERSION=$(echo "$version_info" | cut -d: -f1)
        IMAGE_TYPE=$(echo "$version_info" | cut -d: -f2)
        print_info "Configuration from .fedora-version: Fedora $FEDORA_VERSION with $IMAGE_TYPE"
    fi
    
    # Check if Containerfile exists
    if [[ ! -f "$CONTAINERFILE" ]]; then
        print_error "Containerfile not found at $CONTAINERFILE"
        
        # Try to find Containerfile variants
        print_info "Searching for Containerfile variants..."
        local possible_locations=(
            "${REPO_ROOT}/Containerfile.atomic"
            "${REPO_ROOT}/Containerfile.bootc"
            "${REPO_ROOT}/Containerfile"
            "${REPO_ROOT}/containerfile"
            "${REPO_ROOT}/Dockerfile"
        )
        
        for loc in "${possible_locations[@]}"; do
            if [[ -f "$loc" ]]; then
                print_info "Found Containerfile at: $loc"
                CONTAINERFILE="$loc"
                break
            fi
        done
        
        # If still not found, list directory contents for debugging
        if [[ ! -f "$CONTAINERFILE" ]]; then
            print_error "Could not locate any Containerfile variant. Directory contents:"
            ls -la "$REPO_ROOT" >&2 || true
            exit 1
        fi
    fi
    
    print_success "Using Containerfile: $CONTAINERFILE"
    
    local from_line
    from_line=$(grep -i "^FROM" "$CONTAINERFILE" | head -n1)
    
    if [[ -z "$from_line" ]]; then
        print_error "No FROM line found in Containerfile"
        exit 1
    fi
    
    # Extract Fedora version from Containerfile if not already set from .fedora-version
    if [[ -z "${FEDORA_VERSION:-}" ]]; then
        FEDORA_VERSION=$(echo "$from_line" | grep -oP '\d+|rawhide' || echo "unknown")
    fi
    
    # Extract image type from Containerfile if not already set from .fedora-version
    if [[ -z "${IMAGE_TYPE:-}" ]]; then
        if [[ "$from_line" =~ fedora-sway-atomic ]]; then
            IMAGE_TYPE="fedora-sway-atomic"
            IMAGE_TYPE_DISPLAY="Fedora Sway Atomic Desktop"
        elif [[ "$from_line" =~ fedora-bootc ]]; then
            IMAGE_TYPE="fedora-bootc"
            IMAGE_TYPE_DISPLAY="Fedora bootc Base"
        else
            IMAGE_TYPE="unknown"
            IMAGE_TYPE_DISPLAY="Unknown"
        fi
    else
        # Set display name based on IMAGE_TYPE from .fedora-version
        if [[ "$IMAGE_TYPE" == "fedora-sway-atomic" ]]; then
            IMAGE_TYPE_DISPLAY="Fedora Sway Atomic Desktop"
        elif [[ "$IMAGE_TYPE" == "fedora-bootc" ]]; then
            IMAGE_TYPE_DISPLAY="Fedora bootc Base"
        else
            IMAGE_TYPE_DISPLAY="$IMAGE_TYPE"
        fi
    fi
    
    # Plymouth support detection
    if [[ "$IMAGE_TYPE" == "fedora-bootc" ]]; then
        PLYMOUTH_SUPPORT="✅ Available (custom themes supported)"
        PLYMOUTH_NOTE="Custom Plymouth themes from \`custom-configs/plymouth/\` are applied during build with \`ENABLE_PLYMOUTH=true\`."
    else
        PLYMOUTH_SUPPORT="⚠️ Not available (atomic base uses built-in Plymouth config)"
        PLYMOUTH_NOTE="Custom Plymouth themes from \`custom-configs/plymouth/\` are only applied when using \`fedora-bootc\` as the base image type. The \`fedora-sway-atomic\` base image uses its pre-configured Plymouth setup and ignores custom themes."
    fi

    # Greetd display manager support detection
    if [[ "$IMAGE_TYPE" == "fedora-bootc" ]]; then
        GREETD_SUPPORT="✅ Available"
        GREETD_NOTE="greetd.service is enabled and custom configuration is available in \`custom-configs/greetd/\`."
    else
        GREETD_SUPPORT="❌ Not available"
        GREETD_NOTE="The \`fedora-sway-atomic\` image uses SDDM (Simple Desktop Display Manager) by default. Switch to \`fedora-bootc\` if you need greetd."
    fi

    # Build date
    BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
    
    # GitHub repository (from environment or git remote)
    if [[ -n "${GITHUB_REPOSITORY:-}" ]]; then
        GITHUB_REPO="$GITHUB_REPOSITORY"
    else
        # Try to extract from git remote
        if GITHUB_REPO=$(git -C "$REPO_ROOT" remote get-url origin 2>/dev/null | \
                      sed -E 's|.*[:/]([^/]+/[^/]+)(\.git)?$|\1|' | sed 's|\.git$||'); then
            # Clean up any remaining URL artifacts
            GITHUB_REPO=$(echo "$GITHUB_REPO" | sed -E 's|^.*/git/||')
            print_info "Detected GitHub repository from git remote: $GITHUB_REPO"
        else
            print_warning "Could not detect GitHub repository, using placeholder"
            GITHUB_REPO="USER/REPO"
        fi
    fi
    
    GITHUB_OWNER=$(echo "$GITHUB_REPO" | cut -d'/' -f1)
}

# Generate the README content
generate_readme() {
    cat > "$README_FILE" << EOF
# Fedora Bootc Custom Image

[![CI/CD Pipeline](https://github.com/${GITHUB_REPO}/actions/workflows/build.yaml/badge.svg)](https://github.com/${GITHUB_REPO}/actions/workflows/build.yaml)
[![Fedora Version](https://img.shields.io/badge/Fedora-${FEDORA_VERSION}-51A2DA?logo=fedora)](https://fedoraproject.org)
[![bootc](https://img.shields.io/badge/bootc-enabled-success)](https://bootc-dev.github.io/bootc/)

This repository contains the configuration to build a custom, container-based immutable operating system using [**Fedora bootc**](https://docs.fedoraproject.org/en-US/bootc/). The image is built, tested, scanned, and published to multiple container registries using a comprehensive DevSecOps CI/CD pipeline with GitHub Actions.

## Philosophy: Exousia

Exousia (ἐξουσία) is Greek for "authority" and "power."

This is a personal project for building my own DevSecOps-hardened laptop OS using Fedora bootc. Still under development, but the goal is full control and transparency over packages, settings, and behaviors.

The build pipeline supports both bootc and atomic base images, each with their own defaults and configurations. Automated tests help ensure things actually work as development progresses.


## Current Configuration

- **Base Image:** \`${IMAGE_TYPE_DISPLAY}\`
- **Image Type:** \`${IMAGE_TYPE}\`
- **Fedora Version:** ${FEDORA_VERSION}
- **Plymouth Customization:** ${PLYMOUTH_SUPPORT}
- **Greetd Display Manager:** ${GREETD_SUPPORT}
- **Last Updated:** ${BUILD_DATE}

> **Note:** ${PLYMOUTH_NOTE}

## CI/CD Workflow: Fedora Bootc DevSec CI

The pipeline is defined in a single, unified GitHub Actions workflow that automates the entire image lifecycle. The workflow is triggered on:
- Pushes and pull requests to the \`main\` branch
- Nightly schedule (\`20 4 * * *\` UTC)
- Manual workflow dispatch with version/image type selection

### 1. Build Stage

The first stage assembles the container image and prepares it for subsequent stages.

- **Lint**: The \`Containerfile\` is linted using **Hadolint** to ensure best practices
- **Tagging**: Image tags are dynamically generated based on event triggers (\`latest\`, \`nightly\`, branch name, commit SHA)
- **Build**: The image is built using **Buildah**, a daemonless container image builder optimized for CI environments
- **Version Switching**: Supports dynamic Fedora version and base image type switching via workflow dispatch

### 2. Test Stage

After a successful build, the image and repository scripts undergo automated testing.

- **Integration Tests**: **Bats (Bash Automated Testing System)** runs tests against the built container
- **Script Analysis**: All shell scripts are linted with **ShellCheck**
- **Bootc Validation**: Runs \`bootc container lint\` to verify bootc compliance

### 3. Scan Stage

Security scanning ensures the image meets security standards.

- **Vulnerability Scan**: **Trivy** scans for \`CRITICAL\` and \`HIGH\` severity CVEs
- **Static Analysis**: **Semgrep** performs static code analysis

### 4. Push & Sign Stage

If tests pass and the event is not a pull request, the image is published and cryptographically signed.

- **Push**: Image pushed to **GitHub Container Registry (GHCR)** and **Docker Hub**
- **Sign**: Images signed using **Cosign** and **Sigstore** for integrity verification

---

## Getting Started

### Prerequisites

- A system running Fedora (preferably an Atomic variant)
- Access to either Docker Hub or GHCR
- Basic understanding of bootc and container workflows

### Using the Pre-built Image

#### From Docker Hub (Recommended)

\`\`\`bash
# Switch to the custom bootc image
sudo bootc switch docker.io/${GITHUB_OWNER}/exousia:latest

# Apply the update
sudo bootc upgrade
sudo systemctl reboot
\`\`\`

#### From GitHub Container Registry

\`\`\`bash
# Switch to the custom bootc image
sudo bootc switch ghcr.io/${GITHUB_OWNER}/exousia:latest

# Apply the update
sudo bootc upgrade
sudo systemctl reboot
\`\`\`

### Building Locally

\`\`\`bash
# Clone the repository
git clone https://github.com/${GITHUB_REPO}.git
cd \$(basename ${GITHUB_REPO})

# Build the image
make build

# Push to local registry (optional)
make push
\`\`\`

---

## Customization

### Switching Fedora Versions

Use the version switcher script to change Fedora versions or base image types:

\`\`\`bash
# Switch to Fedora 43
./custom-scripts/fedora-version-switcher 43

# Switch to Fedora 42 with standard bootc base
./custom-scripts/fedora-version-switcher 42 fedora-bootc

# Switch to Sway Atomic desktop
./custom-scripts/fedora-version-switcher 42 fedora-sway-atomic

# List available options
./custom-scripts/fedora-version-switcher list
\`\`\`

Or use GitHub Actions workflow dispatch:

1. Go to **Actions** → **Fedora Bootc DevSec CI**
2. Click **Run workflow**
3. Select desired Fedora version and image type
4. Click **Run workflow**

The README will automatically update to reflect the new configuration.

### Modifying Packages

Edit the package lists in \`custom-pkgs/\`:

- \`packages.add\` - Packages to install
- \`packages.remove\` - Packages to remove from base image

### Adding Custom Configuration

Place configuration files in the appropriate \`custom-configs/\` subdirectories:

- \`custom-configs/sway/\` - Sway window manager configuration
- \`custom-configs/greetd/\` - Display manager configuration
- \`custom-configs/plymouth/\` - Boot splash configuration (**fedora-bootc only**)

### Plymouth Boot Splash Configuration

**⚠️ IMPORTANT: Custom Plymouth themes only work with \`fedora-bootc\` base images.**

The Plymouth boot splash configuration depends on your base image type:

| Base Image Type | Plymouth Support | Details |
|-----------------|------------------|---------|
| \`fedora-bootc\` | ✅ Custom themes supported | Uses \`custom-configs/plymouth/themes/bgrt-better-luks/\` |
| \`fedora-sway-atomic\` | ⚠️ Built-in only | Uses pre-configured Plymouth from upstream, custom themes ignored |

**To use custom Plymouth themes:**

1. Switch to \`fedora-bootc\` base image:
   \\\`\\\`\\\`bash
   ./custom-scripts/fedora-version-switcher 43 fedora-bootc
   \\\`\\\`\\\`

2. Ensure Plymouth is enabled in workflow dispatch (enabled by default for fedora-bootc)

3. Your custom theme in \`custom-configs/plymouth/themes/bgrt-better-luks/\` will be applied

**Note:** The \`enable_plymouth\` workflow input only affects \`fedora-bootc\` builds. It has no effect on \`fedora-sway-atomic\` builds, which always use the upstream Plymouth configuration.

### Greetd Display Manager

**⚠️ IMPORTANT: The greetd display manager is only available for \`fedora-bootc\` base images.**

The greetd display manager availability depends on your base image type:

| Base Image Type | Greetd Support | Details |
|-----------------|----------------|---------|
| \`fedora-bootc\` | ✅ Available | greetd.service enabled, custom config in \`custom-configs/greetd/\` |
| \`fedora-sway-atomic\` | ❌ Not available | Uses SDDM display manager instead |

**Note:** ${GREETD_NOTE}

**To use greetd display manager:**

1. Switch to \`fedora-bootc\` base image:
   \\\`\\\`\\\`bash
   ./custom-scripts/fedora-version-switcher 43 fedora-bootc
   \\\`\\\`\\\`

2. Customize the greetd configuration in \`custom-configs/greetd/config.toml\` as needed

### Custom Scripts

Add executable scripts to \`custom-scripts/\` - they will be copied to \`/usr/local/bin/\`

---

## Required Secrets

To use the full CI/CD pipeline, configure these secrets in your repository:

**Settings → Secrets and variables → Actions**

### For GitHub Container Registry (GHCR):
- \`GHCR_PAT\`: Personal Access Token with \`write:packages\` scope

### For Docker Hub:
- \`DOCKERHUB_USERNAME\`: Your Docker Hub username
- \`DOCKERHUB_TOKEN\`: Access token with Read, Write, Delete permissions

### For Code Coverage (Codecov):
- \`CODECOV_TOKEN\`: Repository upload token from [codecov.io](https://codecov.io)
  1. Sign up at https://codecov.io with your GitHub account
  2. Add your repository to Codecov
  3. Copy the repository upload token
  4. Add as \`CODECOV_TOKEN\` secret in GitHub Actions

**Benefits:**
- Detailed coverage reports with branch coverage tracking
- PR comments showing coverage changes
- Coverage trend visualization
- Integration with GitHub checks

---

## Known Issues

### GHCR Authentication

Currently experiencing authentication issues with \`bootc switch\` and \`bootc upgrade\` when using GHCR. The commands work flawlessly with Docker Hub. While \`skopeo inspect\` and \`podman pull\` work with GHCR, bootc operations return "403 Forbidden | Invalid Username/Password" errors.

**Workaround:** Use Docker Hub for bootc operations until this is resolved.

---

## Documentation

This repository includes comprehensive documentation for building, testing, and managing your bootc image:

### Core Documentation

- **[BOOTC_IMAGE_BUILDER.md](docs/BOOTC_IMAGE_BUILDER.md)** - Build bootable disk images for local testing with bootc-image-builder
- **[BOOTC_UPGRADE.md](docs/BOOTC_UPGRADE.md)** - Complete guide to upgrading, switching, and rolling back bootc deployments
- **[TESTING.md](docs/TESTING.md)** - Comprehensive test suite documentation with 52+ automated tests

### Testing Documentation

- **[Testing Guide](docs/testing/guide.md)** - In-depth testing architecture, test categories, and best practices
- **[Testing README](docs/testing/README.md)** - Quick start guide for running the test suite
- **[Test Suite Details](docs/testing/test_suite.md)** - Detailed test suite information

### Reference Documentation

- **[Plymouth Usage](docs/reference/plymouth_usage_doc.md)** - Configure and customize the boot splash screen
- **[Troubleshooting](docs/reference/troubleshooting.md)** - Common issues and solutions
- **[Writing Tests](docs/reference/writing-tests.md)** - Guide for contributing new tests

---

## External Resources

### Official Documentation
- [Fedora bootc Documentation](https://docs.fedoraproject.org/en-US/bootc/)
- [bootc Project](https://bootc-dev.github.io/bootc/)
- [Base Images](https://docs.fedoraproject.org/en-US/bootc/base-images/)
- [Building Containers](https://docs.fedoraproject.org/en-US/bootc/building-containers/)

### Community Resources
- [Fedora Discussion - bootc](https://discussion.fedoraproject.org/tag/bootc)
- [bootc Issue Tracker](https://gitlab.com/fedora/bootc/tracker)
- [BlueBuild](https://blue-build.org/) - Declarative image builder for bootc
- [BlueBuild Module Reference](https://blue-build.org/reference/module/)

### Articles & Guides
- [Getting Started With Bootc](https://docs.fedoraproject.org/en-US/bootc/getting-started/)
- [How to rebase to Fedora Silverblue 43 Beta](https://fedoramagazine.org/how-to-rebase-to-fedora-silverblue-43-beta/)
- [A Great Journey Towards Fedora CoreOS and Bootc](https://fedoramagazine.org/a-great-journey-towards-fedora-coreos-and-bootc/)
- [Building Your Own Atomic Bootc Desktop](https://fedoramagazine.org/building-your-own-atomic-bootc-desktop/)

### Technical References
- [Bootupd RPM dependency workaround](https://github.com/coreos/bootupd/issues/468)
- [Unification of boot loader updates](https://gitlab.com/fedora/bootc/tracker/-/issues/61)
- [Add Plymouth to Fedora-Bootc](https://www.reddit.com/r/Fedora/comments/1nq636t/comment/ngbgfkh/)

---

## Contributing

Contributions are welcome! Please feel free to submit pull requests or open issues for bugs and feature requests.

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- The Fedora Project and bootc maintainers
- [Universal Blue](https://universal-blue.org/) for pioneering container-native desktop workflows
- [BlueBuild](https://blue-build.org/) for the declarative YAML specification that inspired our build system
- [bootcrew](https://github.com/bootcrew) for community-driven bootc projects and examples
- The broader container and immutable OS community
- All contributors to the referenced documentation and guides
- **Claude** (Anthropic) and **GPT Codex** (OpenAI) for AI-assisted development

### Development Notes

This project leverages AI-assisted development practices. The build pipeline, testing framework, and automation scripts were developed in collaboration with Claude and GPT Codex, demonstrating modern DevOps workflows enhanced by AI capabilities.

---

**Built with Fedora bootc**

*This README was automatically generated on ${BUILD_DATE}*
EOF
}

show_usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Generate a dynamic README.md with current build configuration.

OPTIONS:
    --image-type TYPE   Specify image type (fedora-bootc or fedora-sway-atomic)
    --containerfile PATH Specify path to Containerfile
    --dry-run          Show what would be generated without writing
    --help             Show this help message

ENVIRONMENT VARIABLES:
    GITHUB_REPOSITORY    GitHub repository (e.g., user/repo)
    IMAGE_TYPE           Image type hint (fedora-bootc or fedora-sway-atomic)
    CI                   Set to 'true' in CI environments

CONTAINERFILE SELECTION:
    The script will look for Containerfiles in this order:
    1. Read from .fedora-version file (VERSION:IMAGE_TYPE format)
    2. Containerfile.bootc (if image type is fedora-bootc)
    3. Containerfile.atomic (if image type is fedora-sway-atomic)
    4. Containerfile symlink target
    5. Any available Containerfile variant

EXAMPLES:
    $0                                    # Auto-detect from .fedora-version
    $0 --image-type fedora-sway-atomic   # Use Containerfile.atomic
    $0 --image-type fedora-bootc         # Use Containerfile.bootc
    $0 --containerfile ./Containerfile.atomic  # Specify exact file
    $0 --dry-run                         # Preview without writing

EOF
}

main() {
    local dry_run=false
    local custom_containerfile=""
    local custom_image_type=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            --image-type)
                custom_image_type="$2"
                shift 2
                ;;
            --containerfile)
                custom_containerfile="$2"
                shift 2
                ;;
            --help|-h)
                show_usage
                exit 0
                ;;
            *)
                echo "Unknown option: $1" >&2
                show_usage
                exit 1
                ;;
        esac
    done
    
    # Override IMAGE_TYPE if provided
    if [[ -n "$custom_image_type" ]]; then
        IMAGE_TYPE="$custom_image_type"
        print_info "Using custom image type: $IMAGE_TYPE"
    fi
    
    # Override CONTAINERFILE if provided
    if [[ -n "$custom_containerfile" ]]; then
        CONTAINERFILE="$custom_containerfile"
        print_info "Using custom Containerfile: $CONTAINERFILE"
    fi
    
    print_info "Extracting configuration from Containerfile..."
    extract_config
    
    print_info "Configuration detected:"
    echo "  - Fedora Version: $FEDORA_VERSION"
    echo "  - Image Type: $IMAGE_TYPE_DISPLAY"
    echo "  - Containerfile: $(basename "$CONTAINERFILE")"
    echo "  - GitHub Repo: $GITHUB_REPO"
    echo
    
    if [[ "$dry_run" == true ]]; then
        print_info "Dry run mode - displaying generated content:"
        echo "─────────────────────────────────────────────"
        generate_readme
        cat "$README_FILE"
        echo "─────────────────────────────────────────────"
        print_warning "Dry run complete - README.md was not modified"
    else
        print_info "Generating README.md..."
        generate_readme
        print_success "README.md generated successfully at: $README_FILE"
        
        if [[ "${CI:-false}" != "true" ]]; then
            echo
            print_info "Next steps:"
            echo "  1. Review the generated README: less README.md"
            echo "  2. Commit the changes: git add README.md && git commit"
        fi
    fi
}

main "$@"