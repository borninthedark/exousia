# Byakuya - Captain of the 6th Division, Law & Order
# Validates file structure, generates Containerfile, runs Hadolint + Checkov +
# Trivy config scan + Bandit, then uploads the generated Containerfile for Kyoraku.

name: "Byakuya - Security"

on:
  workflow_call:

permissions:
  contents: read

jobs:
  security-scan:
    name: Security & Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify required file structure
        run: |
          echo "## Byakuya: File Structure Check" >> $GITHUB_STEP_SUMMARY

          for file in sway.desktop environment start-sway; do
            if [[ ! -f "overlays/sway/session/$file" ]]; then
              echo "ERROR: Missing overlays/sway/session/$file"
              exit 1
            fi
          done

          for dir in window-managers common; do
            if [[ ! -d "overlays/base/packages/$dir" ]]; then
              echo "ERROR: Missing overlays/base/packages/$dir directory"
              exit 1
            fi
          done

          for script in setup-plymouth-theme dracut-rebuild; do
            if [[ ! -f "overlays/sway/scripts/setup/$script" ]]; then
              echo "ERROR: Missing overlays/sway/scripts/setup/$script"
              exit 1
            fi
          done

          echo "All required files present" >> $GITHUB_STEP_SUMMARY

      - name: Transpile YAML blueprint
        id: transpile
        uses: ./.github/actions/transpile

      - name: Hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile.generated
          ignore: DL3041,DL3059,DL4006,SC3040

      - name: Upload generated Containerfile
        uses: actions/upload-artifact@v6
        with:
          name: containerfile-generated
          path: Dockerfile.generated
          retention-days: 1

      - name: Checkov (Containerfile)
        uses: bridgecrewio/checkov-action@v12
        with:
          file: Dockerfile.generated
          framework: dockerfile
          quiet: true
          soft_fail: true
          skip_check: CKV_DOCKER_2,CKV_DOCKER_3

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: config
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: 0

      - name: Bandit (Python SAST)
        run: uv run bandit -r tools/ -ll -c pyproject.toml

      - name: Security summary
        if: always()
        run: |
          echo "## Byakuya: Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hadolint | Containerfile |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | Containerfile |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | Repository config |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | Python tools/ |" >> $GITHUB_STEP_SUMMARY
