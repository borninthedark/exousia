# Aizen - 5th Division, Lily of the Valley (Sacrifice) - Orchestrator
# Calls Kaname (CI) + Gin (security) in parallel, then Kyoraku, then gate.
#
# Shinigami Pipeline:
#   Aizen     -> Orchestrator (5th Division, Lily of the Valley -- Sacrifice)
#   Kaname    -> CI: lint + test (9th Division, Buttercup -- Oblivion)
#   Gin       -> Security scanning (3rd Division, Marigold -- Despair)
#   Kyoraku  -> Build -> scan + sign -> release (1st Division, Chrysanthemums -- Truth and Innocence)

name: "Aizen - Orchestrator"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "10 */8 * * *"  # Every 8 hours: 00:10, 08:10, 16:10 UTC
  workflow_dispatch:
    inputs:
      image_type:
        description: "Fedora image type to build"
        required: true
        type: choice
        options:
          - "fedora-sway-atomic"
          - "fedora-bootc"
        default: "fedora-sway-atomic"
      distro_version:
        description: "Fedora version"
        required: true
        type: choice
        options:
          - "43"
          - "44"
          - "rawhide"
        default: "43"
      enable_plymouth:
        description: "Enable Plymouth boot splash"
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # -- Kaname (CI) + Gin (Security) run in parallel --
  kaname:
    name: "Kaname (CI)"
    uses: ./.github/workflows/kaname.yml
    secrets: inherit
    permissions:
      contents: read

  gin:
    name: "Gin (Security)"
    uses: ./.github/workflows/gin.yml
    permissions:
      contents: read

  # -- Kyoraku (Build) runs after both pass --
  kyoraku:
    name: "Kyoraku (Build)"
    needs: [kaname, gin]
    uses: ./.github/workflows/kyoraku.yml
    with:
      image_type: ${{ inputs.image_type || 'fedora-sway-atomic' }}
      distro_version: ${{ inputs.distro_version || '43' }}
      enable_plymouth: ${{ inputs.enable_plymouth == '' && true || inputs.enable_plymouth }}
    secrets: inherit
    permissions:
      contents: write
      packages: write
      id-token: write

  # -- Gate: summary of all jobs --
  gate:
    name: "Gate (Summary)"
    needs: [kaname, gin, kyoraku]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Pipeline summary
        run: |
          echo "## Aizen Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kaname (CI) | ${{ needs.kaname.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gin (Security) | ${{ needs.gin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyoraku (Build) | ${{ needs.kyoraku.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: >-
          needs.kaname.result == 'failure' ||
          needs.gin.result == 'failure' ||
          needs.kyoraku.result == 'failure'
        run: exit 1
