# Aizen - The Mastermind - Orchestrator
# Calls Mayuri (CI) + Byakuya (security) in parallel, then Kyoraku (build), then gate.
#
# Shinigami Pipeline:
#   Aizen     -> Orchestrator (the one who sees everything)
#   Mayuri    -> CI: lint + test (12th Division, Research & Development)
#   Byakuya  -> Security scanning (6th Division, law & order)
#   Kyoraku  -> Build + push (Captain-Commander, master strategist)
#   Unohana   -> Release: semver + retag (4th Division, healing & renewal)

name: "Aizen - Orchestrator"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_type:
        description: "Fedora image type to build"
        required: true
        type: choice
        options:
          - "fedora-sway-atomic"
          - "fedora-bootc"
        default: "fedora-sway-atomic"
      distro_version:
        description: "Fedora version"
        required: true
        type: choice
        options:
          - "43"
          - "44"
          - "rawhide"
        default: "43"
      enable_plymouth:
        description: "Enable Plymouth boot splash"
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # -- Mayuri (CI) + Byakuya (Security) run in parallel --
  mayuri:
    name: "Mayuri (CI)"
    uses: ./.github/workflows/mayuri.yml
    permissions:
      contents: read

  byakuya:
    name: "Byakuya (Security)"
    uses: ./.github/workflows/byakuya.yml
    permissions:
      contents: read

  # -- Kyoraku (Build) runs after both pass --
  kyoraku:
    name: "Kyoraku (Build)"
    needs: [mayuri, byakuya]
    uses: ./.github/workflows/kyoraku.yml
    with:
      image_type: ${{ inputs.image_type || 'fedora-sway-atomic' }}
      distro_version: ${{ inputs.distro_version || '43' }}
      enable_plymouth: ${{ inputs.enable_plymouth == '' && true || inputs.enable_plymouth }}
    secrets: inherit
    permissions:
      contents: read
      packages: write

  # -- Gate: summary of all jobs --
  gate:
    name: "Gate (Summary)"
    needs: [mayuri, byakuya, kyoraku]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Pipeline summary
        run: |
          echo "## Aizen Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mayuri (CI) | ${{ needs.mayuri.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Byakuya (Security) | ${{ needs.byakuya.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyoraku (Build) | ${{ needs.kyoraku.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: >-
          needs.mayuri.result == 'failure' ||
          needs.byakuya.result == 'failure' ||
          needs.kyoraku.result == 'failure'
        run: exit 1

  # -- Unohana (Release) runs after gate on main pushes --
  unohana:
    name: "Unohana (Release)"
    needs: [gate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/unohana.yml
    secrets: inherit
    permissions:
      contents: write
      packages: write
