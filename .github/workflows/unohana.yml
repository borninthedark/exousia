# Unohana Retsu - 4th Division Captain - Weekly ZFS Build
# The first Kenpachi -- destroyer turned healer, serene exterior masking
# immense power. ZFS builds are heavyweight (DKMS compilation), requiring
# quiet precision. Mirrors Aizen's structure but hardcodes enable_zfs: true.
#
# Shinigami Pipeline:
#   Unohana   -> ZFS build orchestrator (4th Division, destroyer turned healer)

name: "Unohana - ZFS Build"

on:
  schedule:
    - cron: "10 4 * * 0"  # Weekly: Sunday 04:10 UTC
  workflow_dispatch:
    inputs:
      image_type:
        description: "Fedora image type to build"
        required: true
        type: choice
        options:
          - "fedora-sway-atomic"
          - "fedora-bootc"
        default: "fedora-sway-atomic"
      distro_version:
        description: "Fedora version"
        required: true
        type: choice
        options:
          - "43"
          - "44"
          - "rawhide"
        default: "43"
      enable_plymouth:
        description: "Enable Plymouth boot splash"
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # -- Mayuri (CI) + Byakuya (Security) run in parallel --
  mayuri:
    name: "Mayuri (CI)"
    uses: ./.github/workflows/mayuri.yml
    secrets: inherit
    permissions:
      contents: read

  byakuya:
    name: "Byakuya (Security)"
    uses: ./.github/workflows/byakuya.yml
    permissions:
      contents: read

  # -- Kyoraku (Build) runs after both pass, with ZFS forced on --
  kyoraku:
    name: "Kyoraku (ZFS Build)"
    needs: [mayuri, byakuya]
    uses: ./.github/workflows/kyoraku.yml
    with:
      image_type: ${{ inputs.image_type || 'fedora-sway-atomic' }}
      distro_version: ${{ inputs.distro_version || '43' }}
      enable_plymouth: ${{ inputs.enable_plymouth == '' && true || inputs.enable_plymouth }}
      enable_zfs: true
    secrets: inherit
    permissions:
      contents: write
      packages: write
      id-token: write

  # -- Gate: summary of all jobs --
  gate:
    name: "Gate (Summary)"
    needs: [mayuri, byakuya, kyoraku]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Pipeline summary
        run: |
          echo "## Unohana ZFS Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mayuri (CI) | ${{ needs.mayuri.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Byakuya (Security) | ${{ needs.byakuya.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kyoraku (ZFS Build) | ${{ needs.kyoraku.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: >-
          needs.mayuri.result == 'failure' ||
          needs.byakuya.result == 'failure' ||
          needs.kyoraku.result == 'failure'
        run: exit 1
