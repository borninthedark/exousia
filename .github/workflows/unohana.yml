# Unohana - Captain of the 4th Division, Healing & Renewal - Release
# Semver from conventional commits, retag images, create GitHub Release.

name: "Unohana - Release"

on:
  workflow_call:

env:
  REGISTRY_URL: ${{ vars.REGISTRY_URL || 'docker.io' }}
  IMAGE_PATH: ${{ vars.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Extract version components
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Analyze commits since last tag
          COMMITS=$(git log "$LATEST_TAG"..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          if echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?!:|BREAKING CHANGE"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif echo "$COMMITS" | grep -qiE "^fix(\(.+\))?:"; then
            PATCH=$((PATCH + 1))
          else
            echo "No conventional commits found - skipping release"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Next version: $NEW_VERSION"

      - name: Login to Docker Hub
        if: steps.version.outputs.skip != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Retag image with semver
        if: steps.version.outputs.skip != 'true'
        id: retag
        run: |
          IMAGE="${{ env.REGISTRY_URL }}/${{ env.IMAGE_PATH }}"
          VERSION="${{ steps.version.outputs.version }}"

          docker pull "${IMAGE}:latest"
          docker tag "${IMAGE}:latest" "${IMAGE}:${VERSION}"
          docker push "${IMAGE}:${VERSION}"

          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE}:${VERSION}" | cut -d@ -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Install cosign
        if: steps.version.outputs.skip != 'true'
        uses: sigstore/cosign-installer@v3

      - name: Sign release image by digest
        if: steps.version.outputs.skip != 'true'
        run: |
          cosign sign --yes \
            --oidc-issuer=https://token.actions.githubusercontent.com \
            --oidc-client-id=sigstore \
            "${{ env.REGISTRY_URL }}/${{ env.IMAGE_PATH }}@${{ steps.retag.outputs.digest }}"

      - name: Create tag
        if: steps.version.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        if: steps.version.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          generate_release_notes: true

      - name: Release summary
        if: always()
        run: |
          echo "## Unohana: Release Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.version.outputs.skip }}" == "true" ]]; then
            echo "No release needed (no conventional commits)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Released **${{ steps.version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
            echo "Image: \`${{ env.IMAGE_PATH }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
