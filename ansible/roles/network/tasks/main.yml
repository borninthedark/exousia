---
# Transient network configuration
# Writes to /run/NetworkManager/conf.d/ and uses nmcli --temporary
# All changes are lost on reboot.

- name: Ensure transient NetworkManager config dir exists
  ansible.builtin.file:
    path: /run/NetworkManager/conf.d
    state: directory
    mode: "0755"

- name: Set transient DNS servers
  ansible.builtin.command:
    cmd: >-
      nmcli --temporary connection modify
      "$(nmcli -t -f NAME connection show --active | head -1)"
      ipv4.dns "{{ network_dns_servers | join(' ') }}"
  changed_when: true
  when: network_dns_servers | length > 0

- name: Restart NetworkManager to apply transient config
  ansible.builtin.systemd:
    name: NetworkManager
    state: restarted
  when: network_dns_servers | length > 0
