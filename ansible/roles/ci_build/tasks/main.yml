---
# CI Build role - orchestrates the full build pipeline locally or on remote hosts.
# Mirrors what GitHub Actions CI does but can run anywhere via Ansible.
#
# Steps: generate Containerfile -> buildah build -> push to registry -> run tests

- name: Ensure uv is available
  ansible.builtin.command:
    cmd: uv --version
  changed_when: false

- name: Sync project dependencies
  ansible.builtin.command:
    cmd: uv sync
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: true

- name: Resolve build configuration
  ansible.builtin.command:
    cmd: uv run python tools/resolve_build_config.py
    chdir: "{{ ci_build_repo_dir }}"
  environment:
    INPUT_IMAGE_TYPE: "{{ ci_build_image_type }}"
    INPUT_DISTRO_VERSION: "{{ ci_build_distro_version }}"
    INPUT_ENABLE_PLYMOUTH: "{{ ci_build_enable_plymouth }}"
  register: resolve_config
  changed_when: true

- name: Ruff (lint check)
  ansible.builtin.command:
    cmd: uv run ruff check tools/
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: false

- name: Black (format check)
  ansible.builtin.command:
    cmd: uv run black --check tools/
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: false

- name: isort (import order check)
  ansible.builtin.command:
    cmd: uv run isort --check-only tools/
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: false

- name: Generate Containerfile from YAML
  ansible.builtin.command:
    cmd: >-
      uv run python tools/yaml-to-containerfile.py
      --config {{ ci_build_yaml_config }}
      --output Containerfile.generated
      --verbose
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: true

- name: Hadolint (Containerfile lint)
  ansible.builtin.command:
    cmd: >-
      podman run --rm -i docker.io/hadolint/hadolint
      hadolint --ignore DL3041 --ignore DL3059 --ignore DL4006 --ignore SC3040 -
    stdin: "{{ lookup('file', ci_build_repo_dir + '/Containerfile.generated') }}"
  changed_when: false
  failed_when: false

- name: Run Python tests
  ansible.builtin.command:
    cmd: uv run pytest tools/ -v --tb=short
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: false

- name: Bandit (Python SAST)
  ansible.builtin.command:
    cmd: uv run bandit -r tools/ -ll -c pyproject.toml
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: false

- name: Build image with buildah
  ansible.builtin.command:
    cmd: >-
      buildah build
      --format oci
      --tls-verify=true
      --layers
      --build-arg FEDORA_VERSION={{ ci_build_distro_version }}
      --build-arg IMAGE_TYPE={{ ci_build_image_type }}
      --build-arg ENABLE_PLYMOUTH={{ ci_build_enable_plymouth }}
      -t {{ ci_build_registry }}/{{ ci_build_image }}:{{ ci_build_tag }}
      -t {{ ci_build_registry }}/{{ ci_build_image }}:latest
      -f Containerfile.generated .
    chdir: "{{ ci_build_repo_dir }}"
  changed_when: true

- name: Push to registry
  ansible.builtin.command:
    cmd: >-
      buildah push
      {{ ci_build_registry }}/{{ ci_build_image }}:{{ ci_build_tag }}
  when: ci_build_push | default(false)
  changed_when: true

- name: Push latest tag
  ansible.builtin.command:
    cmd: >-
      buildah push
      {{ ci_build_registry }}/{{ ci_build_image }}:latest
  when: ci_build_push | default(false)
  changed_when: true

- name: Run Bats integration tests
  ansible.builtin.command:
    cmd: >-
      buildah unshare -- bats -r custom-tests --formatter tap
    chdir: "{{ ci_build_repo_dir }}"
  environment:
    TEST_IMAGE_TAG: "{{ ci_build_registry }}/{{ ci_build_image }}:{{ ci_build_tag }}"
  when: ci_build_run_bats | default(false)
  changed_when: false
