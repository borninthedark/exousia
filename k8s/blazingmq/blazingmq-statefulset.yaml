---
# BlazingMQ StatefulSet for Cloud Deployment
# Provides high-availability message queue cluster

apiVersion: v1
kind: ServiceAccount
metadata:
  name: blazingmq
  namespace: exousia
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blazingmq-config
  namespace: exousia
data:
  broker.json: |
    {
      "appConfig": {
        "brokerInstanceName": "exousia-cluster",
        "brokerVersion": 999999,
        "configVersion": 1,
        "hostName": "blazingmq",
        "hostTags": ["cloud", "production"],
        "hostDataCenter": "us-east-1",
        "isRunningOnDev": false,
        "logsObserverMaxSize": 5000,
        "dispatcherConfig": {
          "sessions": {
            "heartbeatIntervalMs": 3000
          },
          "queues": {
            "allocator": {
              "type": "COUNTING"
            }
          }
        },
        "stats": {
          "snapshotInterval": 30,
          "appIdTagDomains": ["exousia"],
          "plugins": [
            {
              "name": "prometheus",
              "publishInterval": 15,
              "port": 9091
            }
          ]
        },
        "networkInterfaces": {
          "tcpInterface": {
            "name": "tcp",
            "port": 30114,
            "ioThreads": 8,
            "maxConnections": 10000
          },
          "heartbeats": {
            "client": 30,
            "downstreamBroker": 60,
            "upstreamBroker": 60,
            "cluster": 30
          }
        }
      },
      "domainConfig": {
        "domains": [
          {
            "name": "exousia",
            "mode": "priority",
            "storage": {
              "domainLimits": {
                "messages": 100000000,
                "bytes": 107374182400
              },
              "queueLimits": {
                "messages": 10000000,
                "bytes": 10737418240
              },
              "config": {
                "clusterName": "exousia-cluster",
                "fileStore": {
                  "location": "/var/lib/blazingmq/storage"
                }
              }
            },
            "queues": [
              {
                "name": "build.queue",
                "mode": "priority",
                "maxDeliveryAttempts": 5,
                "deduplicationTimeMs": 300000,
                "consistencyLevel": "strong",
                "subscriptions": []
              },
              {
                "name": "build.dlq",
                "mode": "fanout",
                "maxDeliveryAttempts": 1,
                "consistencyLevel": "strong",
                "subscriptions": []
              },
              {
                "name": "build.status",
                "mode": "priority",
                "maxDeliveryAttempts": 3,
                "deduplicationTimeMs": 60000,
                "consistencyLevel": "eventual",
                "subscriptions": []
              }
            ]
          }
        ]
      }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: blazingmq
  namespace: exousia
  labels:
    app: blazingmq
spec:
  type: ClusterIP
  clusterIP: None  # Headless service for StatefulSet
  ports:
    - name: tcp
      port: 30114
      targetPort: 30114
      protocol: TCP
    - name: admin
      port: 30115
      targetPort: 30115
      protocol: TCP
    - name: metrics
      port: 9091
      targetPort: 9091
      protocol: TCP
  selector:
    app: blazingmq
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: blazingmq
  namespace: exousia
spec:
  serviceName: blazingmq
  replicas: 3  # 3-node cluster for high availability
  selector:
    matchLabels:
      app: blazingmq
  template:
    metadata:
      labels:
        app: blazingmq
    spec:
      serviceAccountName: blazingmq
      containers:
        - name: blazingmq
          image: bloomberg/blazingmq:latest
          ports:
            - name: tcp
              containerPort: 30114
              protocol: TCP
            - name: admin
              containerPort: 30115
              protocol: TCP
            - name: metrics
              containerPort: 9091
              protocol: TCP
          env:
            - name: BMQ_BROKER_CONFIG
              value: /etc/blazingmq/broker.json
            - name: BMQ_LOG_LEVEL
              value: INFO
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: config
              mountPath: /etc/blazingmq
              readOnly: true
            - name: storage
              mountPath: /var/lib/blazingmq
            - name: logs
              mountPath: /var/log/blazingmq
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            exec:
              command:
                - bmqstoragetool
                - check
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 30114
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: blazingmq-config
  volumeClaimTemplates:
    - metadata:
        name: storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: fast-ssd  # Use fast SSD for message storage
        resources:
          requests:
            storage: 100Gi
    - metadata:
        name: logs
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: standard
        resources:
          requests:
            storage: 20Gi
---
# Service Monitor for Prometheus (if using Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: blazingmq
  namespace: exousia
  labels:
    app: blazingmq
spec:
  selector:
    matchLabels:
      app: blazingmq
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
