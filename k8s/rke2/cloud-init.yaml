#cloud-config
# Cloud-init configuration for RKE2 bootc VM
# ===========================================
#
# This cloud-init configuration:
# - Sets up hostname and networking
# - Mounts host directories for kubeconfig export
# - Configures RKE2 registry to point to host
# - Optionally customizes RKE2 config
#
# Usage:
#   virt-install ... --cloud-init user-data=/path/to/this/file
#   OR with bootc-image-builder

# Hostname and locale
hostname: rke2-node-1
fqdn: rke2-node-1.local
locale: en_US.UTF-8
timezone: UTC

# Users (optional - bootc images may have predefined users)
users:
  - name: core
    groups: [wheel, docker]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    # Add your SSH public key here
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQD... user@host

# SSH configuration
ssh_pwauth: false
disable_root: true

# Package updates (optional - bootc handles this via bootc upgrade)
package_update: false
package_upgrade: false

# Mounts for host integration
# ============================
# These mounts enable:
# 1. Kubeconfig export to host
# 2. Optional persistent storage
#
# On the host, create these directories and configure libvirt:
#   mkdir -p /var/lib/libvirt/rke2/kubeconfig
#   mkdir -p /var/lib/libvirt/rke2/storage
mounts:
  # Mount for kubeconfig export
  - ["kubeconfigshare", "/mnt/host/kubeconfig", "9p", "trans=virtio,version=9p2000.L,rw", "0", "0"]
  # Mount for persistent storage (optional)
  - ["storageshare", "/mnt/host/storage", "9p", "trans=virtio,version=9p2000.L,rw", "0", "0"]

# Write configuration files
# ==========================
write_files:
  # Custom RKE2 config (override defaults)
  - path: /etc/rancher/rke2/config.yaml.d/cloud-init.yaml
    permissions: '0644'
    content: |
      # Cloud-init RKE2 configuration overrides
      # This supplements the base config from the container image

      # Set node name to match hostname
      node-name: rke2-node-1

      # Add node labels
      node-label:
        - "node.exousia.io/environment=vm"
        - "node.exousia.io/type=bootc"

  # Custom registry configuration (if different from default)
  # Uncomment and modify if your host registry is on a different IP
  # - path: /etc/rancher/rke2/registries.yaml.d/cloud-init.yaml
  #   permissions: '0644'
  #   content: |
  #     mirrors:
  #       docker.io:
  #         endpoint:
  #           - "http://192.168.122.1:5000"
  #     configs:
  #       "192.168.122.1:5000":
  #         tls:
  #           insecure_skip_verify: true

  # Helper script for kubeconfig on host
  - path: /usr/local/bin/setup-host-kubeconfig
    permissions: '0755'
    content: |
      #!/bin/bash
      # Setup kubeconfig for host access
      set -euo pipefail

      KUBECONFIG_SRC="/etc/rancher/rke2/rke2.yaml"
      KUBECONFIG_DST="/mnt/host/kubeconfig/rke2.yaml"

      # Wait for RKE2 to generate kubeconfig
      while [ ! -f "$KUBECONFIG_SRC" ]; do
        echo "Waiting for RKE2 kubeconfig..."
        sleep 2
      done

      # Export to host mount
      if [ -d "$(dirname "$KUBECONFIG_DST")" ]; then
        cp "$KUBECONFIG_SRC" "$KUBECONFIG_DST"
        chmod 644 "$KUBECONFIG_DST"
        echo "Kubeconfig exported to host: $KUBECONFIG_DST"

        # Get VM IP for host instructions
        VM_IP=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
        echo ""
        echo "On the host, run:"
        echo "  cp /var/lib/libvirt/rke2/kubeconfig/rke2.yaml ~/.kube/config"
        echo "  sed -i 's|https://127.0.0.1:6443|https://${VM_IP}:6443|' ~/.kube/config"
        echo "  kubectl cluster-info"
      else
        echo "Warning: Host mount not available at $(dirname "$KUBECONFIG_DST")"
      fi

# Run commands on first boot
# ===========================
runcmd:
  # Ensure mount points exist
  - mkdir -p /mnt/host/kubeconfig
  - mkdir -p /mnt/host/storage

  # Mount host shares (if not already mounted via mounts section)
  # Note: This is a fallback if mounts section doesn't work
  # - mount -t 9p -o trans=virtio,version=9p2000.L kubeconfigshare /mnt/host/kubeconfig || true

  # Wait for RKE2 to start (systemd should handle this)
  - systemctl enable rke2-server.service
  - systemctl start rke2-server.service

  # Export kubeconfig after RKE2 starts
  - sleep 30 && /usr/local/bin/setup-host-kubeconfig || true

# System information
# ==================
final_message: |
  ╔═══════════════════════════════════════════════════════════╗
  ║         RKE2 Node Ready - Exousia Bootc                   ║
  ╠═══════════════════════════════════════════════════════════╣
  ║                                                           ║
  ║  RKE2 is starting up. This may take a few minutes.       ║
  ║                                                           ║
  ║  Check status:  rke2-status                              ║
  ║  View logs:     journalctl -u rke2-server -f             ║
  ║  Export config: rke2-kubeconfig --export                 ║
  ║                                                           ║
  ║  Bootc upgrade: bootc upgrade && systemctl reboot        ║
  ║  Bootc status:  bootc status                             ║
  ║                                                           ║
  ╚═══════════════════════════════════════════════════════════╝

# Power state (keep running)
power_state:
  mode: reboot
  message: Cloud-init complete, rebooting...
  delay: now
  condition: true
